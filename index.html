<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Karting Telemetry Sessions</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #1e1e1e 0%, #2d2d2d 100%);
      color: #e0e0e0;
      min-height: 100vh;
      padding: 20px;
    }

    .container {
      max-width: 1400px;
      margin: 0 auto;
    }

    .header {
      background: linear-gradient(135deg, #d32f2f 0%, #f44336 100%);
      padding: 40px;
      border-radius: 12px;
      margin-bottom: 30px;
      box-shadow: 0 8px 32px rgba(211, 47, 47, 0.3);
      text-align: center;
    }

    h1 {
      font-size: 3em;
      margin-bottom: 10px;
      text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
    }

    .subtitle {
      font-size: 1.2em;
      opacity: 0.9;
    }

    .controls {
      background: #2d2d2d;
      padding: 20px;
      border-radius: 12px;
      margin-bottom: 30px;
      display: flex;
      gap: 15px;
      flex-wrap: wrap;
      align-items: center;
    }

    .search-box {
      flex: 1;
      min-width: 220px;
      padding: 12px;
      background: #1e1e1e;
      border: 2px solid #3d3d3d;
      color: #e0e0e0;
      border-radius: 8px;
      font-size: 1em;
    }

    select.search-box {
      cursor: pointer;
    }

    .filter-group {
      display: flex;
      gap: 10px;
    }

    .filter-btn {
      padding: 10px 20px;
      background: #3d3d3d;
      color: #e0e0e0;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
      transition: all 0.3s;
    }

    .filter-btn:hover {
      background: #4d4d4d;
    }

    .filter-btn.active {
      background: #f44336;
      color: white;
    }

    .stats-summary {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }

    .stat-card {
      background: #2d2d2d;
      padding: 20px;
      border-radius: 12px;
      border-left: 4px solid #f44336;
      text-align: center;
    }

    .stat-label {
      color: #999;
      font-size: 0.9em;
      text-transform: uppercase;
      margin-bottom: 8px;
    }

    .stat-value {
      font-size: 2em;
      font-weight: bold;
      color: #ffd700;
    }

    .sessions-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
      gap: 20px;
    }

    .session-card {
      background: #2d2d2d;
      border-radius: 12px;
      padding: 25px;
      box-shadow: 0 4px 16px rgba(0,0,0,0.2);
      transition: all 0.3s;
      cursor: pointer;
      border-top: 4px solid #f44336;
    }

    .session-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 8px 24px rgba(244, 67, 54, 0.3);
    }

    .session-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
    }

    .driver-name {
      font-size: 1.5em;
      font-weight: bold;
      color: #fff;
    }

    .session-date {
      color: #999;
      font-size: 0.9em;
    }

    .session-stats {
      margin: 15px 0;
    }

    .session-stat {
      display: flex;
      justify-content: space-between;
      margin: 8px 0;
      padding: 8px 0;
      border-bottom: 1px solid #3d3d3d;
    }

    .stat-name {
      color: #999;
    }

    .stat-val {
      font-weight: bold;
      color: #ffd700;
    }

    .view-btn {
      display: block;
      width: 100%;
      padding: 12px;
      background: #f44336;
      color: white;
      border: none;
      border-radius: 8px;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.3s;
      margin-top: 15px;
    }

    .view-btn:hover {
      background: #d32f2f;
    }

    .loading {
      text-align: center;
      padding: 50px;
      font-size: 1.5em;
      color: #999;
    }

    .no-results {
      text-align: center;
      padding: 50px;
      color: #999;
    }

    .error {
      background: #f44336;
      color: white;
      padding: 20px;
      border-radius: 8px;
      margin: 20px 0;
      text-align: center;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>üèéÔ∏è Karting Telemetry</h1>
      <div class="subtitle">Track your performance across all sessions</div>
    </div>

    <div class="stats-summary" id="summary-stats">
      <div class="stat-card">
        <div class="stat-label">Total Sessions</div>
        <div class="stat-value" id="total-sessions">-</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">Best Lap Ever</div>
        <div class="stat-value" id="best-lap-ever" style="font-size: 1.5em;">-</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">Total Laps</div>
        <div class="stat-value" id="total-laps">-</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">Tracks Driven</div>
        <div class="stat-value" id="tracks-count">-</div>
      </div>
    </div>

    <div class="controls">
      <input 
        type="text" 
        class="search-box" 
        id="search-input" 
        placeholder="üîç Search by driver..."
      >

      <select id="track-filter" class="search-box">
        <option value="">All Tracks</option>
      </select>

      <select id="config-filter" class="search-box">
        <option value="">All Configurations</option>
      </select>

      <div class="filter-group">
        <button class="filter-btn active" data-sort="date">Latest First</button>
        <button class="filter-btn" data-sort="fastest">Fastest First</button>
      </div>
    </div>

    <div id="sessions-container">
      <div class="loading">Loading sessions...</div>
    </div>
  </div>

  <script>
    let allSessions = [];
    let filteredSessions = [];
    let currentSort = 'date';

    async function loadSessionsList() {
      const container = document.getElementById('sessions-container');

      try {
        const res = await fetch('sessions/sessions-list.json');
        const list = await res.json();
        allSessions = list.sessions;

        if (!allSessions || allSessions.length === 0) {
          container.innerHTML = '<div class="error">No sessions found.</div>';
          return;
        }

        updateSummaryStats();
        populateFilters();
        filteredSessions = [...allSessions];
        renderSessions();

      } catch (e) {
        container.innerHTML = '<div class="error">Failed to load sessions list.</div>';
      }
    }

    function populateFilters() {
      const trackSelect = document.getElementById("track-filter");
      const configSelect = document.getElementById("config-filter");

      const tracks = [...new Set(allSessions.map(s => s.track.name))];
      const configs = [...new Set(allSessions.map(s => s.track.configuration || ""))];

      tracks.forEach(t => {
        const opt = document.createElement("option");
        opt.value = t;
        opt.textContent = t;
        trackSelect.appendChild(opt);
      });

      configs.forEach(c => {
        if (!c) return;
        const opt = document.createElement("option");
        opt.value = c;
        opt.textContent = c;
        configSelect.appendChild(opt);
      });
    }

    function parseTime(timeStr) {
      const p = timeStr.split(":");
      return parseInt(p[0]) * 60 + parseFloat(p[1]);
    }

    function updateSummaryStats() {
      document.getElementById("total-sessions").textContent = allSessions.length;

      const totalLaps = allSessions.reduce((a, s) => a + s.laps_count, 0);
      document.getElementById("total-laps").textContent = totalLaps;

      const trackSet = new Set(allSessions.map(s => s.track.name));
      document.getElementById("tracks-count").textContent = trackSet.size;

      const allFastestTimes = allSessions.map(s => parseTime(s.fastest_lap));
      const minTime = Math.min(...allFastestTimes);
      const best = allSessions.find(s => parseTime(s.fastest_lap) === minTime);
      document.getElementById("best-lap-ever").textContent = best.fastest_lap;
    }

    function renderSessions() {
      const container = document.getElementById('sessions-container');
      if (filteredSessions.length === 0) {
        container.innerHTML = '<div class="no-results">No matching sessions.</div>';
        return;
      }

      const html = filteredSessions.map(s => `
        <div class="session-card" onclick="viewSession('${s.id}')">
          <div class="session-header">
            <div class="driver-name">${s.driver}</div>
            <div class="session-date">${new Date(s.session_date).toLocaleDateString()}</div>
          </div>

          <div class="session-stats">
            <div class="session-stat">
              <span class="stat-name">Track</span>
              <span class="stat-val">${s.track.name}</span>
            </div>

            <div class="session-stat">
              <span class="stat-name">Configuration</span>
              <span class="stat-val">${s.track.configuration}</span>
            </div>

            <div class="session-stat">
              <span class="stat-name">Kart</span>
              <span class="stat-val">${s.kart}</span>
            </div>

            <div class="session-stat">
              <span class="stat-name">Fastest</span>
              <span class="stat-val">üèÜ ${s.fastest_lap}</span>
            </div>

            <div class="session-stat">
              <span class="stat-name">Average</span>
              <span class="stat-val">${s.average_lap}</span>
            </div>

            <div class="session-stat">
              <span class="stat-name">Laps</span>
              <span class="stat-val">${s.laps_count}</span>
            </div>
          </div>

          <button class="view-btn">View Full Telemetry ‚Üí</button>
        </div>
      `).join("");

      container.innerHTML = `<div class="sessions-grid">${html}</div>`;
    }

    function viewSession(id) {
      window.location.href = `session.html?id=${id}`;
    }

    function sortSessions(type) {
      currentSort = type;

      if (type === "date") {
        filteredSessions.sort((a, b) => new Date(b.session_date) - new Date(a.session_date));
      } else if (type === "fastest") {
        filteredSessions.sort((a, b) => parseTime(a.fastest_lap) - parseTime(b.fastest_lap));
      }

      renderSessions();
    }

    function filterSessions(searchTerm) {
      const term = searchTerm.toLowerCase();
      const t = document.getElementById("track-filter").value;
      const c = document.getElementById("config-filter").value;

      filteredSessions = allSessions.filter(s =>
        (s.driver.toLowerCase().includes(term) ||
        s.track.name.toLowerCase().includes(term)) &&
        (t === "" || s.track.name === t) &&
        (c === "" || s.track.configuration === c)
      );

      sortSessions(currentSort);
    }

    document.getElementById("search-input").addEventListener("input", e => {
      filterSessions(e.target.value);
    });

    document.getElementById("track-filter").addEventListener("change", () => {
      filterSessions(document.getElementById("search-input").value);
    });

    document.getElementById("config-filter").addEventListener("change", () => {
      filterSessions(document.getElementById("search-input").value);
    });

    document.querySelectorAll(".filter-btn").forEach(btn => {
      btn.addEventListener("click", e => {
        document.querySelectorAll(".filter-btn").forEach(b => b.classList.remove("active"));
        e.target.classList.add("active");
        sortSessions(e.target.dataset.sort);
      });
    });

    loadSessionsList();
  </script>
</body>
</html>
