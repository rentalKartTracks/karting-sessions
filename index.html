<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kart Session Statistics</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            color: #e6e6e6;
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        
        header {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid #0f3460;
        }
        
        h1 {
            color: #e94560;
            font-size: 2.5rem;
            margin-bottom: 10px;
            text-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }
        
        .subtitle {
            color: #7d8da6;
            font-size: 1.1rem;
        }
        
        .filter-section {
            background: rgba(15, 52, 96, 0.3);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 30px;
            border: 1px solid #0f3460;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        
        .filter-title {
            color: #4cc9f0;
            margin-bottom: 15px;
            font-size: 1.3rem;
        }
        
        .filter-controls {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            align-items: center;
        }
        
        select, input {
            background: rgba(22, 33, 62, 0.8);
            border: 1px solid #0f3460;
            border-radius: 6px;
            padding: 10px 15px;
            color: #e6e6e6;
            font-size: 1rem;
            min-width: 200px;
        }
        
        select:focus, input:focus {
            outline: none;
            border-color: #4cc9f0;
            box-shadow: 0 0 0 2px rgba(76, 201, 240, 0.2);
        }
        
        button {
            background: linear-gradient(to right, #e94560, #d4334e);
            color: white;
            border: none;
            border-radius: 6px;
            padding: 10px 20px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        button:hover {
            background: linear-gradient(to right, #d4334e, #c3223e);
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(233, 69, 96, 0.3);
        }
        
        button#reset-filter {
            background: linear-gradient(to right, #4cc9f0, #2db8e0);
        }
        
        button#reset-filter:hover {
            background: linear-gradient(to right, #2db8e0, #1ca7cf);
            box-shadow: 0 4px 8px rgba(76, 201, 240, 0.3);
        }
        
        .stats-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 40px;
        }
        
        .stat-card {
            background: rgba(22, 33, 62, 0.6);
            border-radius: 12px;
            padding: 25px;
            border: 1px solid #0f3460;
            transition: all 0.3s ease;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        
        .stat-card:hover {
            transform: translateY(-5px);
            border-color: #4cc9f0;
            box-shadow: 0 8px 15px rgba(0,0,0,0.2);
        }
        
        .stat-label {
            color: #7d8da6;
            font-size: 1rem;
            margin-bottom: 10px;
            text-transform: uppercase;
            letter-spacing: 1px;
            font-weight: 600;
        }
        
        .session-stat {
            color: #f8f9fa;
            font-size: 2rem;
            font-weight: 700;
            font-family: 'Courier New', monospace;
        }
        
        .highlight {
            color: #4cc9f0;
        }
        
        .danger {
            color: #e94560;
        }
        
        .success {
            color: #4ade80;
        }
        
        .sessions-table-container {
            background: rgba(22, 33, 62, 0.6);
            border-radius: 12px;
            padding: 25px;
            border: 1px solid #0f3460;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        
        .table-title {
            color: #4cc9f0;
            margin-bottom: 20px;
            font-size: 1.3rem;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
        }
        
        thead {
            background: rgba(15, 52, 96, 0.5);
        }
        
        th {
            padding: 15px;
            text-align: left;
            color: #4cc9f0;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1px;
            border-bottom: 2px solid #0f3460;
        }
        
        td {
            padding: 15px;
            border-bottom: 1px solid rgba(15, 52, 96, 0.3);
        }
        
        tr:hover {
            background: rgba(76, 201, 240, 0.1);
        }
        
        .filter-indicator {
            background: rgba(233, 69, 96, 0.1);
            border-left: 4px solid #e94560;
            padding: 15px;
            border-radius: 0 6px 6px 0;
            margin-bottom: 20px;
            display: none;
        }
        
        .filter-indicator.active {
            display: block;
        }
        
        .status-indicator {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-right: 8px;
        }
        
        .status-active {
            background: #4ade80;
        }
        
        @media (max-width: 768px) {
            .filter-controls {
                flex-direction: column;
                align-items: stretch;
            }
            
            select, input, button {
                width: 100%;
            }
            
            .stats-container {
                grid-template-columns: 1fr;
            }
            
            th, td {
                padding: 10px;
                font-size: 0.9rem;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>üèéÔ∏è Kart Session Statistics</h1>
            <p class="subtitle">Track your performance with detailed session analytics</p>
        </header>
        
        <div class="filter-indicator" id="filterIndicator">
            <strong>Active Filters:</strong> <span id="activeFiltersText">None</span>
            <div id="filterStats" style="margin-top: 5px; font-size: 0.9rem;"></div>
        </div>
        
        <section class="filter-section">
            <h2 class="filter-title">Filter Sessions</h2>
            <div class="filter-controls">
                <select id="track-filter">
                    <option value="">All Tracks</option>
                    <option value="Plytinƒós Kartodromas">Plytinƒós Kartodromas</option>
                    <option value="Other Track">Other Track</option>
                </select>
                
                <select id="driver-filter">
                    <option value="">All Drivers</option>
                    <option value="Povilas L.">Povilas L.</option>
                    <option value="Other Driver">Other Driver</option>
                </select>
                
                <input type="date" id="date-from" placeholder="Date From">
                <input type="date" id="date-to" placeholder="Date To">
                
                <button id="apply-filter">
                    <span>üîç Apply Filter</span>
                </button>
                <button id="reset-filter">
                    <span>üîÑ Reset Filter</span>
                </button>
            </div>
        </section>
        
        <section class="stats-container">
            <div class="stat-card">
                <div class="stat-label">Fastest Lap</div>
                <div class="session-stat highlight" data-stat="fastest-lap">--:--.--</div>
            </div>
            
            <div class="stat-card">
                <div class="stat-label">Average Lap</div>
                <div class="session-stat" data-stat="average-lap">--:--.--</div>
            </div>
            
            <div class="stat-card">
                <div class="stat-label">Total Laps</div>
                <div class="session-stat success" data-stat="laps-count">0</div>
            </div>
            
            <div class="stat-card">
                <div class="stat-label">Kart Number</div>
                <div class="session-stat" data-stat="kart-number">N/A</div>
            </div>
            
            <div class="stat-card">
                <div class="stat-label">Sessions Count</div>
                <div class="session-stat success" data-stat="sessions-count">0</div>
            </div>
            
            <div class="stat-card">
                <div class="stat-label">Avg Laps/Session</div>
                <div class="session-stat" data-stat="avg-laps-per-session">0</div>
            </div>
        </section>
        
        <section class="sessions-table-container">
            <h2 class="table-title">Session History</h2>
            <table id="sessionsTable">
                <thead>
                    <tr>
                        <th>Date</th>
                        <th>Driver</th>
                        <th>Track</th>
                        <th>Fastest Lap</th>
                        <th>Avg Lap</th>
                        <th>Laps</th>
                        <th>Kart</th>
                    </tr>
                </thead>
                <tbody id="sessionsTableBody">
                    <!-- Sessions will be populated by JavaScript -->
                </tbody>
            </table>
        </section>
    </div>

    <script>
        // Session Data
        const sessionsData = {
            "sessions": [
                {
                    "id": "example-session",
                    "driver": "Povilas L.",
                    "track": {
                        "name": "Plytinƒós Kartodromas",
                        "configuration": "Summer"
                    },
                    "session_date": "2025-07-17",
                    "fastest_lap": "00:44.030",
                    "kart": "9 Ag",
                    "laps_count": 7,
                    "average_lap": "00:44.67"
                },
                {
                    "id": "2ffe82e0-f2df-4334-80ba-c3e6125b82c9",
                    "driver": "Povilas L.",
                    "track": {
                        "name": "Plytinƒós Kartodromas",
                        "configuration": "Summer"
                    },
                    "session_date": "2025-12-07",
                    "fastest_lap": "00:43.997",
                    "kart": "9 Ag",
                    "laps_count": 13,
                    "average_lap": "00:45.478"
                },
                {
                    "id": "3ffe82e0-f2df-4334-80ba-c3e6125b82c9",
                    "driver": "Povilas L.",
                    "track": {
                        "name": "Plytinƒós Kartodromas",
                        "configuration": "Winter"
                    },
                    "session_date": "2025-01-15",
                    "fastest_lap": "00:45.120",
                    "kart": "7 Ag",
                    "laps_count": 10,
                    "average_lap": "00:46.210"
                },
                {
                    "id": "4ffe82e0-f2df-4334-80ba-c3e6125b82c9",
                    "driver": "Other Driver",
                    "track": {
                        "name": "Other Track",
                        "configuration": "Standard"
                    },
                    "session_date": "2025-09-22",
                    "fastest_lap": "00:42.850",
                    "kart": "12 Ag",
                    "laps_count": 15,
                    "average_lap": "00:44.150"
                }
            ]
        };

        // DOM Elements
        const filterIndicator = document.getElementById('filterIndicator');
        const activeFiltersText = document.getElementById('activeFiltersText');
        const filterStats = document.getElementById('filterStats');
        const sessionsTableBody = document.getElementById('sessionsTableBody');

        // Helper function to convert lap time string to milliseconds
        function convertLapTimeToMs(lapTime) {
            if (!lapTime || lapTime === 'N/A' || lapTime === '--:--.--') return Infinity;
            
            try {
                // Handle format "00:44.030"
                const [minSec, ms] = lapTime.split('.');
                const [minutes, seconds] = minSec.split(':').map(Number);
                
                return (minutes * 60000) + (seconds * 1000) + (Number(ms) * 10);
            } catch (e) {
                console.error('Error converting lap time:', lapTime, e);
                return Infinity;
            }
        }

        // Helper function to convert milliseconds to lap time string
        function convertMsToLapTime(ms) {
            if (!isFinite(ms) || ms === Infinity || ms === 0) return '--:--.--';
            
            const minutes = Math.floor(ms / 60000);
            const seconds = Math.floor((ms % 60000) / 1000);
            const milliseconds = Math.floor((ms % 1000) / 10);
            
            return `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}.${milliseconds.toString().padStart(2, '0')}`;
        }

        // Function to get the latest session
        function getLatestSession(sessions) {
            if (sessions.length === 0) return null;
            
            return sessions.reduce((latest, current) => {
                const latestDate = new Date(latest.session_date);
                const currentDate = new Date(current.session_date);
                return currentDate > latestDate ? current : latest;
            });
        }

        // Function to filter sessions based on criteria
        function filterSessions(filters = {}) {
            let filtered = [...sessionsData.sessions];
            
            // Apply filters
            if (filters.track) {
                filtered = filtered.filter(session => 
                    session.track.name === filters.track
                );
            }
            
            if (filters.driver) {
                filtered = filtered.filter(session => 
                    session.driver === filters.driver
                );
            }
            
            if (filters.dateFrom) {
                filtered = filtered.filter(session => {
                    const sessionDate = new Date(session.session_date);
                    return sessionDate >= new Date(filters.dateFrom);
                });
            }
            
            if (filters.dateTo) {
                filtered = filtered.filter(session => {
                    const sessionDate = new Date(session.session_date);
                    // Set to end of day
                    const toDate = new Date(filters.dateTo);
                    toDate.setHours(23, 59, 59, 999);
                    return sessionDate <= toDate;
                });
            }
            
            return filtered;
        }

        // Function to calculate aggregate stats from filtered sessions
        function calculateFilteredStats(filteredSessions) {
            if (filteredSessions.length === 0) {
                return {
                    fastest_lap: '--:--.--',
                    average_lap: '--:--.--',
                    total_laps: 0,
                    avg_laps_per_session: 0,
                    sessions_count: 0,
                    kart_number: 'N/A'
                };
            }
            
            // Find fastest lap across all filtered sessions
            let fastestLap = filteredSessions[0].fastest_lap;
            let fastestTime = convertLapTimeToMs(fastestLap);
            
            filteredSessions.forEach(session => {
                const currentTime = convertLapTimeToMs(session.fastest_lap);
                if (currentTime < fastestTime) {
                    fastestTime = currentTime;
                    fastestLap = session.fastest_lap;
                }
            });
            
            // Calculate average of averages weighted by laps count
            const totalLaps = filteredSessions.reduce((sum, session) => 
                sum + session.laps_count, 0
            );
            
            const totalTime = filteredSessions.reduce((sum, session) => {
                const avgTimeMs = convertLapTimeToMs(session.average_lap);
                return sum + (avgTimeMs * session.laps_count);
            }, 0);
            
            const overallAverageLap = totalLaps > 0 ? 
                convertMsToLapTime(totalTime / totalLaps) : '--:--.--';
            
            // Get most recent kart (for single session view)
            const latestSession = getLatestSession(filteredSessions);
            
            return {
                fastest_lap: fastestLap,
                average_lap: overallAverageLap,
                total_laps: totalLaps,
                avg_laps_per_session: totalLaps > 0 ? Math.round(totalLaps / filteredSessions.length) : 0,
                sessions_count: filteredSessions.length,
                kart_number: filteredSessions.length === 1 ? latestSession.kart : 'Multiple'
            };
        }

        // Function to update stat cards
        function updateStatCards(stats) {
            const statElements = document.querySelectorAll('.session-stat');
            
            statElements.forEach(stat => {
                const statType = stat.getAttribute('data-stat');
                
                if (!statType) return;
                
                switch(statType) {
                    case 'fastest-lap':
                        stat.textContent = stats.fastest_lap;
                        break;
                    case 'average-lap':
                        stat.textContent = stats.average_lap;
                        break;
                    case 'laps-count':
                        stat.textContent = stats.total_laps;
                        break;
                    case 'sessions-count':
                        stat.textContent = stats.sessions_count;
                        break;
                    case 'avg-laps-per-session':
                        stat.textContent = stats.avg_laps_per_session;
                        break;
                    case 'kart-number':
                        stat.textContent = stats.kart_number;
                        break;
                }
            });
        }

        // Function to populate sessions table
        function populateSessionsTable(sessions) {
            sessionsTableBody.innerHTML = '';
            
            if (sessions.length === 0) {
                sessionsTableBody.innerHTML = `
                    <tr>
                        <td colspan="7" style="text-align: center; padding: 40px; color: #7d8da6;">
                            No sessions found matching the selected filters
                        </td>
                    </tr>
                `;
                return;
            }
            
            sessions.forEach(session => {
                const row = document.createElement('tr');
                
                // Format date for display
                const sessionDate = new Date(session.session_date);
                const formattedDate = sessionDate.toLocaleDateString('en-US', {
                    year: 'numeric',
                    month: 'short',
                    day: 'numeric'
                });
                
                row.innerHTML = `
                    <td>${formattedDate}</td>
                    <td>${session.driver}</td>
                    <td>${session.track.name} (${session.track.configuration})</td>
                    <td class="highlight">${session.fastest_lap}</td>
                    <td>${session.average_lap}</td>
                    <td>${session.laps_count}</td>
                    <td>${session.kart}</td>
                `;
                
                sessionsTableBody.appendChild(row);
            });
        }

        // Function to update filter indicator
        function updateFilterIndicator(filters, filteredSessions) {
            const activeFilters = [];
            
            if (filters.track) activeFilters.push(`Track: ${filters.track}`);
            if (filters.driver) activeFilters.push(`Driver: ${filters.driver}`);
            if (filters.dateFrom) activeFilters.push(`From: ${filters.dateFrom}`);
            if (filters.dateTo) activeFilters.push(`To: ${filters.dateTo}`);
            
            if (activeFilters.length > 0) {
                activeFiltersText.textContent = activeFilters.join(', ');
                filterIndicator.classList.add('active');
                
                // Update filter stats
                filterStats.innerHTML = `
                    Showing ${filteredSessions.length} of ${sessionsData.sessions.length} sessions
                    (${Math.round((filteredSessions.length / sessionsData.sessions.length) * 100)}%)
                `;
            } else {
                filterIndicator.classList.remove('active');
                activeFiltersText.textContent = 'None';
                filterStats.innerHTML = '';
            }
        }

        // Function to apply filters and update everything
        function applyFilters() {
            const filters = {
                track: document.getElementById('track-filter').value,
                driver: document.getElementById('driver-filter').value,
                dateFrom: document.getElementById('date-from').value,
                dateTo: document.getElementById('date-to').value
            };
            
            const filteredSessions = filterSessions(filters);
            
            // Update everything based on filtered sessions
            if (filteredSessions.length === 1) {
                // Single session - show that session's data
                const session = filteredSessions[0];
                const stats = {
                    fastest_lap: session.fastest_lap,
                    average_lap: session.average_lap,
                    total_laps: session.laps_count,
                    avg_laps_per_session: session.laps_count,
                    sessions_count: 1,
                    kart_number: session.kart
                };
                updateStatCards(stats);
            } else {
                // Multiple sessions - show aggregated stats
                const stats = calculateFilteredStats(filteredSessions);
                updateStatCards(stats);
            }
            
            // Update table and filter indicator
            populateSessionsTable(filteredSessions);
            updateFilterIndicator(filters, filteredSessions);
        }

        // Function to reset filters
        function resetFilters() {
            document.getElementById('track-filter').value = '';
            document.getElementById('driver-filter').value = '';
            document.getElementById('date-from').value = '';
            document.getElementById('date-to').value = '';
            
            // Show latest session data
            const latestSession = getLatestSession(sessionsData.sessions);
            const stats = {
                fastest_lap: latestSession.fastest_lap,
                average_lap: latestSession.average_lap,
                total_laps: latestSession.laps_count,
                avg_laps_per_session: latestSession.laps_count,
                sessions_count: 1,
                kart_number: latestSession.kart
            };
            
            updateStatCards(stats);
            populateSessionsTable(sessionsData.sessions);
            updateFilterIndicator({}, sessionsData.sessions);
        }

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', () => {
            // Set default date values to last 30 days
            const today = new Date();
            const thirtyDaysAgo = new Date();
            thirtyDaysAgo.setDate(today.getDate() - 30);
            
            document.getElementById('date-from').valueAsDate = thirtyDaysAgo;
            document.getElementById('date-to').valueAsDate = today;
            
            // Initial load with latest session
            const latestSession = getLatestSession(sessionsData.sessions);
            const initialStats = {
                fastest_lap: latestSession.fastest_lap,
                average_lap: latestSession.average_lap,
                total_laps: latestSession.laps_count,
                avg_laps_per_session: latestSession.laps_count,
                sessions_count: sessionsData.sessions.length,
                kart_number: latestSession.kart
            };
            
            updateStatCards(initialStats);
            populateSessionsTable(sessionsData.sessions);
            
            // Add event listeners
            document.getElementById('apply-filter').addEventListener('click', applyFilters);
            document.getElementById('reset-filter').addEventListener('click', resetFilters);
            
            // Apply filters on filter change (optional)
            document.getElementById('track-filter').addEventListener('change', applyFilters);
            document.getElementById('driver-filter').addEventListener('change', applyFilters);
            document.getElementById('date-from').addEventListener('change', applyFilters);
            document.getElementById('date-to').addEventListener('change', applyFilters);
        });
    </script>
</body>
</html>
