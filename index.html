<!DOCTYPE html>
<html>

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Karting Telemetry Sessions</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #1e1e1e 0%, #2d2d2d 100%);
      color: #e0e0e0;
      min-height: 100vh;
      padding: 20px;
    }

    .container {
      max-width: 1400px;
      margin: 0 auto;
    }

    .header {
      background: linear-gradient(135deg, #d32f2f 0%, #f44336 100%);
      padding: 40px;
      border-radius: 12px;
      margin-bottom: 30px;
      box-shadow: 0 8px 32px rgba(211, 47, 47, 0.3);
      text-align: center;
    }

    h1 {
      font-size: 3em;
      margin-bottom: 10px;
      text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
    }

    .subtitle {
      font-size: 1.2em;
      opacity: 0.9;
    }

    .controls {
      background: #2d2d2d;
      padding: 20px;
      border-radius: 12px;
      margin-bottom: 30px;
      display: flex;
      gap: 15px;
      flex-wrap: wrap;
      align-items: center;
    }

    .search-box {
      flex: 1;
      min-width: 200px;
      padding: 12px;
      background: #1e1e1e;
      border: 2px solid #3d3d3d;
      color: #e0e0e0;
      border-radius: 8px;
      font-size: 1em;
    }

    .filter-group {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }

    .filter-btn {
      padding: 10px 20px;
      background: #3d3d3d;
      color: #e0e0e0;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
      transition: all 0.3s;
    }

    .filter-btn:hover {
      background: #4d4d4d;
    }

    .filter-btn.active {
      background: #f44336;
      color: white;
    }

    .select-filter {
      padding: 10px 15px;
      background: #1e1e1e;
      border: 2px solid #3d3d3d;
      color: #e0e0e0;
      border-radius: 8px;
      font-size: 1em;
      min-width: 180px;
    }

    .date-filter-group {
      display: flex;
      gap: 10px;
      align-items: center;
    }

    .date-input {
      padding: 10px;
      background: #1e1e1e;
      border: 2px solid #3d3d3d;
      color: #e0e0e0;
      border-radius: 8px;
      font-size: 1em;
      min-width: 150px;
    }

    .date-range {
      display: flex;
      gap: 5px;
      align-items: center;
    }

    .date-range span {
      color: #999;
    }

    .stats-summary {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }

    .stat-card {
      background: #2d2d2d;
      padding: 20px;
      border-radius: 12px;
      border-left: 4px solid #f44336;
      text-align: center;
    }

    .stat-label {
      color: #999;
      font-size: 0.9em;
      text-transform: uppercase;
      margin-bottom: 8px;
    }

    /* Use a custom class for filtered stats to differentiate from global stats */
    .filtered-stat-value {
      font-size: 2em;
      font-weight: bold;
      color: #ffd700;
    }

    .sessions-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
      gap: 20px;
    }

    .session-card {
      background: #2d2d2d;
      border-radius: 12px;
      padding: 25px;
      box-shadow: 0 4px 16px rgba(0, 0, 0, 0.2);
      transition: all 0.3s;
      cursor: pointer;
      border-top: 4px solid #f44336;
    }

    .session-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 8px 24px rgba(244, 67, 54, 0.3);
    }

    .session-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
    }

    .driver-name {
      font-size: 1.5em;
      font-weight: bold;
      color: #fff;
    }

    .session-date {
      color: #999;
      font-size: 0.9em;
    }

    .session-stats {
      margin: 15px 0;
    }

    .session-stat {
      display: flex;
      justify-content: space-between;
      margin: 8px 0;
      padding: 8px 0;
      border-bottom: 1px solid #3d3d3d;
    }

    .stat-name {
      color: #999;
    }

    .stat-val {
      font-weight: bold;
      color: #ffd700;
    }

    .view-btn {
      display: block;
      width: 100%;
      padding: 12px;
      background: #f44336;
      color: white;
      border: none;
      border-radius: 8px;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.3s;
      margin-top: 15px;
    }

    .view-btn:hover {
      background: #d32f2f;
    }

    .loading {
      text-align: center;
      padding: 50px;
      font-size: 1.5em;
      color: #999;
    }

    .no-results {
      text-align: center;
      padding: 50px;
      color: #999;
    }

    .error {
      background: #f44336;
      color: white;
      padding: 20px;
      border-radius: 8px;
      margin: 20px 0;
      text-align: center;
    }

    .skeleton {
      animation: pulse 1.5s infinite;
    }

    @keyframes pulse {

      0%,
      100% {
        opacity: 1;
      }

      50% {
        opacity: 0.5;
      }
    }
  </style>
</head>

<body>
  <div class="container">
    <div class="header">
      <h1>üèéÔ∏è Karting Telemetry</h1>
      <div class="subtitle">Track your performance across all sessions</div>
    </div>

    <div class="stats-summary" id="summary-stats">
      <div class="stat-card">
        <div class="stat-label">Total Sessions (Filtered)</div>
        <div class="filtered-stat-value" id="filtered-sessions-count">-</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">Best Lap (Filtered)</div>
        <div class="filtered-stat-value" id="filtered-best-lap" style="font-size: 1.5em;">-</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">Total Laps (Filtered)</div>
        <div class="filtered-stat-value" id="filtered-total-laps">-</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">Tracks Driven (Filtered)</div>
        <div class="filtered-stat-value" id="filtered-tracks-count">-</div>
      </div>
    </div>

    <div class="controls">
      <input type="text" class="search-box" id="search-input" placeholder="üîç Search by driver, track, or kart...">

      <select class="select-filter" id="track-filter">
        <option value="">All Tracks</option>
      </select>

      <select class="select-filter" id="config-filter">
        <option value="">All Configurations</option>
      </select>

      <div class="date-filter-group">
        <select class="select-filter" id="date-filter">
          <option value="all">All Time</option>
          <option value="today">Today</option>
          <option value="week">Last 7 Days</option>
          <option value="month">Last 30 Days</option>
          <option value="custom">Custom Range</option>
        </select>

        <div class="date-range" id="custom-date-range" style="display: none;">
          <input type="date" class="date-input" id="date-from">
          <span>to</span>
          <input type="date" class="date-input" id="date-to">
        </div>
      </div>

      <div class="filter-group">
        <button class="filter-btn active" data-sort="date">Latest First</button>
        <button class="filter-btn" data-sort="fastest">Fastest First</button>
      </div>
    </div>

    <div id="sessions-container">
      <div class="loading">Loading sessions...</div>
    </div>
  </div>

  <script>
    let allSessions = [];
    let filteredSessions = [];
    let currentSort = 'date';
    let uniqueTracks = new Set();
    let uniqueConfigs = new Set();

    async function loadAllSessions() {
      const container = document.getElementById('sessions-container');

      try {
        // Fetch the central list file containing all summary data
        const listResponse = await fetch('sessions/sessions-list.json');

        if (!listResponse.ok) {
          throw new Error(`Failed to load sessions-list.json: ${listResponse.statusText}`);
        }

        const sessionList = await listResponse.json();

        if (!sessionList || !Array.isArray(sessionList.sessions)) {
          throw new Error('sessions-list.json is missing the required "sessions" array.');
        }

        // Map the list data into the primary array.
        // NOTE: This assumes 'fastest_lap', 'laps_count', and 'average_lap' are pre-calculated
        // and present in the sessions-list.json file.
        allSessions = sessionList.sessions.map(session => ({
          id: session.id,
          driver: session.driver,
          track_name: session.track ? session.track.name : 'N/A',
          track_config: session.track ? session.track.configuration : 'N/A',
          session_date: session.session_date,
          fastest_lap: session.fastest_lap,
          kart: session.kart,
          laps_count: session.laps_count,
          average_lap: session.average_lap
        }));

        if (allSessions.length === 0) {
          container.innerHTML = '<div class="no-results">No sessions found in the list.</div>';
          return;
        }

        // Extract unique tracks and configurations for filters
        allSessions.forEach(session => {
          uniqueTracks.add(session.track_name);
          uniqueConfigs.add(session.track_config);
        });

        populateFilters();
        filteredSessions = [...allSessions];
        renderSessions();
      } catch (error) {
        console.error('Error loading or processing sessions:', error);
        container.innerHTML = `<div class="error">Error loading sessions: ${error.message}. Please ensure 'sessions/sessions-list.json' is accessible and correctly formatted with summary data.</div>`;
      }
    }

    /**
     * Converts time string (MM:SS.mmm or SS.mmm) to seconds float for calculations.
     */
    function parseTime(timeStr) {
      if (!timeStr) return Infinity;
      timeStr = String(timeStr).trim();
      const parts = timeStr.split(':');
      if (parts.length === 2) {
        const minutes = parseInt(parts[0]);
        const seconds = parseFloat(parts[1]);
        return minutes * 60 + seconds;
      }
      // Handle raw seconds string (e.g., "55.300s")
      const seconds = parseFloat(timeStr.replace('s', ''));
      return isNaN(seconds) ? Infinity : seconds;
    }

    /**
     * Converts seconds float back to time string (MM:SS.mmm or SS.mmm).
     */
    function formatTime(seconds) {
      if (seconds === Infinity || isNaN(seconds)) return '-';
      const mins = Math.floor(seconds / 60);
      const secs = (seconds % 60).toFixed(3);
      return mins > 0 ? `${mins}:${secs.padStart(6, '0')}` : `${secs}s`;
    }

    function populateFilters() {
      const trackFilter = document.getElementById('track-filter');
      const configFilter = document.getElementById('config-filter');

      // Populate track filter
      uniqueTracks.forEach(track => {
        const option = document.createElement('option');
        option.value = track;
        option.textContent = track;
        trackFilter.appendChild(option);
      });

      // Populate configuration filter
      uniqueConfigs.forEach(config => {
        const option = document.createElement('option');
        option.value = config;
        option.textContent = config;
        configFilter.appendChild(option);
      });
    }

    /**
     * Calculates and displays dashboard summary stats (Filtered).
     */
    function updateFilteredSummaryStats() {
      const sessionsToUse = filteredSessions;

      const totalSessions = sessionsToUse.length;
      // Sum pre-calculated laps_count
      const totalLaps = sessionsToUse.reduce((sum, s) => sum + (s.laps_count || 0), 0);

      // Find the best lap by parsing and finding the minimum of the fastest_lap strings
      const allFastestLaps = sessionsToUse
        .map(s => parseTime(s.fastest_lap))
        .filter(t => t !== Infinity);

      const bestLapEver = allFastestLaps.length > 0 ? Math.min(...allFastestLaps) : null;

      const uniqueTrackNames = new Set(sessionsToUse.map(s => s.track_name).filter(n => n && n !== 'N/A'));

      document.getElementById('filtered-sessions-count').textContent = totalSessions;
      document.getElementById('filtered-total-laps').textContent = totalLaps;
      document.getElementById('filtered-tracks-count').textContent = uniqueTrackNames.size;

      document.getElementById('filtered-best-lap').textContent = bestLapEver !== null ? formatTime(bestLapEver) : '-';
    }


    function renderSessions() {
      const container = document.getElementById('sessions-container');

      if (filteredSessions.length === 0) {
        container.innerHTML = '<div class="no-results">No sessions match your search.</div>';
      } else {
        const html = filteredSessions.map(session => {
          // Direct use of pre-calculated list data
          const fastestTime = session.fastest_lap || '-';
          const averageTime = session.average_lap || '-';
          const lapsCount = session.laps_count || 0;

          return `
                                <div class="session-card" onclick="viewSession('${session.id}')">
                                    <div class="session-header">
                                        <div class="driver-name">${session.driver}</div>
                                        <div class="session-date">${new Date(session.session_date).toLocaleDateString()}</div>
                                    </div>
                                    
                                    <div class="session-stats">
                                        <div class="session-stat">
                                            <span class="stat-name">Track</span>
                                            <span class="stat-val">${session.track_name} (${session.track_config})</span>
                                        </div>
                                        <div class="session-stat">
                                            <span class="stat-name">Kart</span>
                                            <span class="stat-val">${session.kart || '-'}</span>
                                        </div>
                                        <div class="session-stat">
                                            <span class="stat-name">Fastest Lap</span>
                                            <span class="stat-val">üèÜ ${fastestTime}</span>
                                        </div>
                                        <div class="session-stat">
                                            <span class="stat-name">Average</span>
                                            <span class="stat-val">${averageTime}</span>
                                        </div>
                                        <div class="session-stat">
                                            <span class="stat-name">Laps</span>
                                            <span class="stat-val">${lapsCount}</span>
                                        </div>
                                    </div>
                                    
                                    <button class="view-btn">View Full Telemetry ‚Üí</button>
                                </div>
                            `;
        }).join('');

        container.innerHTML = `<div class="sessions-grid">${html}</div>`;
      }

      updateFilteredSummaryStats();
    }

    function viewSession(sessionId) {
      // This function directs the user to the detailed page using the session ID
      window.location.href = `session.html?id=${sessionId}`;
    }

    function sortSessions(sortType) {
      currentSort = sortType;

      if (sortType === 'date') {
        filteredSessions.sort((a, b) => new Date(b.session_date) - new Date(a.session_date));
      } else if (sortType === 'fastest') {
        // Sorting uses the parsed fastest_lap string from the list
        filteredSessions.sort((a, b) => parseTime(a.fastest_lap) - parseTime(b.fastest_lap));
      }

      renderSessions();
    }

    function filterSessions() {
      const searchTerm = document.getElementById('search-input').value.toLowerCase();
      const selectedTrack = document.getElementById('track-filter').value;
      const selectedConfig = document.getElementById('config-filter').value;
      const dateFilter = document.getElementById('date-filter').value;

      filteredSessions = allSessions.filter(session => {
        // Search filter
        const kart = (session.kart || '').toLowerCase();
        if (searchTerm &&
          !session.driver.toLowerCase().includes(searchTerm) &&
          !session.track_name.toLowerCase().includes(searchTerm) &&
          !kart.includes(searchTerm)) {
          return false;
        }

        // Track filter
        if (selectedTrack && session.track_name !== selectedTrack) {
          return false;
        }

        // Configuration filter
        if (selectedConfig && session.track_config !== selectedConfig) {
          return false;
        }

        // Date filter logic
        const sessionDate = new Date(session.session_date);
        const today = new Date();
        today.setHours(0, 0, 0, 0);

        if (dateFilter === 'today') {
          const sessionDay = new Date(sessionDate);
          sessionDay.setHours(0, 0, 0, 0);
          if (sessionDay.getTime() !== today.getTime()) return false;
        } else if (dateFilter === 'week') {
          const weekAgo = new Date(today);
          weekAgo.setDate(weekAgo.getDate() - 7);
          if (sessionDate < weekAgo) return false;
        } else if (dateFilter === 'month') {
          const monthAgo = new Date(today);
          monthAgo.setDate(monthAgo.getDate() - 30);
          if (sessionDate < monthAgo) return false;
        } else if (dateFilter === 'custom') {
          const dateFrom = document.getElementById('date-from').value;
          const dateTo = document.getElementById('date-to').value;

          if (dateFrom && new Date(session.session_date) < new Date(dateFrom)) return false;
          if (dateTo) {
            const dateToMax = new Date(dateTo);
            dateToMax.setDate(dateToMax.getDate() + 1);
            if (new Date(session.session_date) >= dateToMax) return false;
          }
        }

        return true;
      });

      sortSessions(currentSort);
    }

    function updateDateFilterVisibility() {
      const dateFilter = document.getElementById('date-filter').value;
      const customRange = document.getElementById('custom-date-range');

      if (dateFilter === 'custom') {
        customRange.style.display = 'flex';
      } else {
        customRange.style.display = 'none';
      }
    }

    // --- Event Listeners and Initialization ---
    document.getElementById('search-input').addEventListener('input', filterSessions);
    document.getElementById('track-filter').addEventListener('change', filterSessions);
    document.getElementById('config-filter').addEventListener('change', filterSessions);
    document.getElementById('date-filter').addEventListener('change', function () {
      updateDateFilterVisibility();
      filterSessions();
    });

    document.getElementById('date-from').addEventListener('change', filterSessions);
    document.getElementById('date-to').addEventListener('change', filterSessions);

    document.querySelectorAll('.filter-btn').forEach(btn => {
      btn.addEventListener('click', (e) => {
        document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
        e.target.classList.add('active');
        sortSessions(e.target.dataset.sort);
      });
    });

    // Set default date values for custom range inputs
    const today = new Date().toISOString().split('T')[0];
    const monthAgo = new Date();
    monthAgo.setDate(monthAgo.getDate() - 30);
    const defaultFrom = monthAgo.toISOString().split('T')[0];

    document.getElementById('date-from').value = defaultFrom;
    document.getElementById('date-to').value = today;
    document.getElementById('date-from').max = today;
    document.getElementById('date-to').max = today;
    document.getElementById('date-to').min = '2020-01-01';
    document.getElementById('date-from').min = '2020-01-01';

    // Load sessions on page load
    loadAllSessions();
  </script>
</body>

</html>
