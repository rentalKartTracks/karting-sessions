<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Karting Telemetry Sessions</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #1e1e1e 0%, #2d2d2d 100%);
      color: #e0e0e0;
      min-height: 100vh;
      padding: 20px;
    }

    .container {
      max-width: 1400px;
      margin: 0 auto;
    }

    .header {
      background: linear-gradient(135deg, #d32f2f 0%, #f44336 100%);
      padding: 40px;
      border-radius: 12px;
      margin-bottom: 30px;
      box-shadow: 0 8px 32px rgba(211, 47, 47, 0.3);
      text-align: center;
    }

    h1 {
      font-size: 3em;
      margin-bottom: 10px;
      text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
    }

    .subtitle {
      font-size: 1.2em;
      opacity: 0.9;
    }

    .controls {
      background: #2d2d2d;
      padding: 20px;
      border-radius: 12px;
      margin-bottom: 30px;
      display: flex;
      gap: 15px;
      flex-wrap: wrap;
      align-items: center;
    }

    .search-box {
      flex: 1;
      min-width: 250px;
      padding: 12px;
      background: #1e1e1e;
      border: 2px solid #3d3d3d;
      color: #e0e0e0;
      border-radius: 8px;
      font-size: 1em;
    }

    .filter-group {
      display: flex;
      gap: 10px;
    }

    .filter-btn {
      padding: 10px 20px;
      background: #3d3d3d;
      color: #e0e0e0;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
      transition: all 0.3s;
    }

    .filter-btn:hover {
      background: #4d4d4d;
    }

    .filter-btn.active {
      background: #f44336;
      color: white;
    }

    .stats-summary {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }

    .stat-card {
      background: #2d2d2d;
      padding: 20px;
      border-radius: 12px;
      border-left: 4px solid #f44336;
      text-align: center;
    }

    .stat-label {
      color: #999;
      font-size: 0.9em;
      text-transform: uppercase;
      margin-bottom: 8px;
    }

    .stat-value {
      font-size: 2em;
      font-weight: bold;
      color: #ffd700;
    }

    .sessions-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
      gap: 20px;
    }

    .session-card {
      background: #2d2d2d;
      border-radius: 12px;
      padding: 25px;
      box-shadow: 0 4px 16px rgba(0,0,0,0.2);
      transition: all 0.3s;
      cursor: pointer;
      border-top: 4px solid #f44336;
    }

    .session-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 8px 24px rgba(244, 67, 54, 0.3);
    }

    .session-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
    }

    .driver-name {
      font-size: 1.5em;
      font-weight: bold;
      color: #fff;
    }

    .session-date {
      color: #999;
      font-size: 0.9em;
    }

    .session-stats {
      margin: 15px 0;
    }

    .session-stat {
      display: flex;
      justify-content: space-between;
      margin: 8px 0;
      padding: 8px 0;
      border-bottom: 1px solid #3d3d3d;
    }

    .stat-name {
      color: #999;
    }

    .stat-val {
      font-weight: bold;
      color: #ffd700;
    }

    .view-btn {
      display: block;
      width: 100%;
      padding: 12px;
      background: #f44336;
      color: white;
      border: none;
      border-radius: 8px;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.3s;
      margin-top: 15px;
    }

    .view-btn:hover {
      background: #d32f2f;
    }

    .loading {
      text-align: center;
      padding: 50px;
      font-size: 1.5em;
      color: #999;
    }

    .no-results {
      text-align: center;
      padding: 50px;
      color: #999;
    }

    .error {
      background: #f44336;
      color: white;
      padding: 20px;
      border-radius: 8px;
      margin: 20px 0;
      text-align: center;
    }

    .skeleton {
      animation: pulse 1.5s infinite;
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>üèéÔ∏è Karting Telemetry</h1>
      <div class="subtitle">Track your performance across all sessions</div>
    </div>

    <div class="stats-summary" id="summary-stats">
      <div class="stat-card">
        <div class="stat-label">Total Sessions</div>
        <div class="stat-value" id="total-sessions">-</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">Best Lap Ever</div>
        <div class="stat-value" id="best-lap-ever" style="font-size: 1.5em;">-</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">Total Laps</div>
        <div class="stat-value" id="total-laps">-</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">Tracks Driven</div>
        <div class="stat-value" id="tracks-count">-</div>
      </div>
    </div>

    <div class="controls">
      <input 
        type="text" 
        class="search-box" 
        id="search-input" 
        placeholder="üîç Search by driver, track, or kart..."
      >
      <div class="filter-group">
        <button class="filter-btn active" data-sort="date">Latest First</button>
        <button class="filter-btn" data-sort="fastest">Fastest First</button>
        <button class="filter-btn" data-sort="driver">By Driver</button>
      </div>
    </div>

    <div id="sessions-container">
      <div class="loading">Loading sessions...</div>
    </div>
  </div>

  <script>
    let allSessions = [];
    let filteredSessions = [];
    let currentSort = 'date';

    // You need to manually list your session IDs here, or use a sessions-list.json file
    const sessionIds = [
      'example-session',
      // Add more session IDs here as you create them
      // 'session-2025-07-20',
      // 'session-2025-07-18',
    ];

    async function loadAllSessions() {
      const container = document.getElementById('sessions-container');
      
      try {
        const promises = sessionIds.map(id => 
          fetch(`sessions/${id}.json`)
            .then(r => r.json())
            .then(data => ({ ...data, id }))
            .catch(() => null)
        );

        const results = await Promise.all(promises);
        allSessions = results.filter(s => s !== null);
        
        if (allSessions.length === 0) {
          container.innerHTML = '<div class="error">No sessions found. Make sure your JSON files are in the sessions/ folder.</div>';
          return;
        }

        updateSummaryStats();
        filteredSessions = [...allSessions];
        renderSessions();
        
      } catch (error) {
        container.innerHTML = '<div class="error">Error loading sessions. Please check your setup.</div>';
      }
    }

    function parseTime(timeStr) {
      const parts = timeStr.split(':');
      if (parts.length === 2) {
        const minutes = parseInt(parts[0]);
        const seconds = parseFloat(parts[1]);
        return minutes * 60 + seconds;
      }
      return parseFloat(timeStr);
    }

    function updateSummaryStats() {
      const totalSessions = allSessions.length;
      const totalLaps = allSessions.reduce((sum, s) => 
        sum + s.laps.filter(l => l.lap !== null).length, 0
      );
      
      const allFastestLaps = allSessions.map(s => parseTime(s.fastest_lap));
      const bestLapEver = Math.min(...allFastestLaps);
      
      const uniqueTracks = new Set(allSessions.map(s => s.track.name));

      document.getElementById('total-sessions').textContent = totalSessions;
      document.getElementById('total-laps').textContent = totalLaps;
      document.getElementById('tracks-count').textContent = uniqueTracks.size;
      
      const bestSession = allSessions.find(s => parseTime(s.fastest_lap) === bestLapEver);
      document.getElementById('best-lap-ever').textContent = bestSession ? bestSession.fastest_lap : '-';
    }

    function renderSessions() {
      const container = document.getElementById('sessions-container');
      
      if (filteredSessions.length === 0) {
        container.innerHTML = '<div class="no-results">No sessions match your search.</div>';
        return;
      }

      const html = filteredSessions.map(session => {
        const validLaps = session.laps.filter(l => l.lap !== null);
        const lapTimes = validLaps.map(l => parseTime(l.time));
        const avgTime = lapTimes.reduce((a, b) => a + b, 0) / lapTimes.length;

        return `
          <div class="session-card" onclick="viewSession('${session.id}')">
            <div class="session-header">
              <div class="driver-name">${session.driver}</div>
              <div class="session-date">${new Date(session.session_date).toLocaleDateString()}</div>
            </div>
            
            <div class="session-stats">
              <div class="session-stat">
                <span class="stat-name">Track</span>
                <span class="stat-val">${session.track.name}</span>
              </div>
              <div class="session-stat">
                <span class="stat-name">Kart</span>
                <span class="stat-val">${session.kart}</span>
              </div>
              <div class="session-stat">
                <span class="stat-name">Fastest Lap</span>
                <span class="stat-val">üèÜ ${session.fastest_lap}</span>
              </div>
              <div class="session-stat">
                <span class="stat-name">Average</span>
                <span class="stat-val">${formatTime(avgTime)}</span>
              </div>
              <div class="session-stat">
                <span class="stat-name">Laps</span>
                <span class="stat-val">${validLaps.length}</span>
              </div>
            </div>
            
            <button class="view-btn">View Full Telemetry ‚Üí</button>
          </div>
        `;
      }).join('');

      container.innerHTML = `<div class="sessions-grid">${html}</div>`;
    }

    function formatTime(seconds) {
      const mins = Math.floor(seconds / 60);
      const secs = (seconds % 60).toFixed(3);
      return mins > 0 ? `${mins}:${secs.padStart(6, '0')}` : `${secs}s`;
    }

    function viewSession(sessionId) {
      window.location.href = `session.html?id=${sessionId}`;
    }

    function sortSessions(sortType) {
      currentSort = sortType;
      
      if (sortType === 'date') {
        filteredSessions.sort((a, b) => new Date(b.session_date) - new Date(a.session_date));
      } else if (sortType === 'fastest') {
        filteredSessions.sort((a, b) => parseTime(a.fastest_lap) - parseTime(b.fastest_lap));
      } else if (sortType === 'driver') {
        filteredSessions.sort((a, b) => a.driver.localeCompare(b.driver));
      }
      
      renderSessions();
    }

    function filterSessions(searchTerm) {
      const term = searchTerm.toLowerCase();
      filteredSessions = allSessions.filter(session => 
        session.driver.toLowerCase().includes(term) ||
        session.track.name.toLowerCase().includes(term) ||
        session.kart.toLowerCase().includes(term) ||
        session.session_date.includes(term)
      );
      sortSessions(currentSort);
    }

    // Event listeners
    document.getElementById('search-input').addEventListener('input', (e) => {
      filterSessions(e.target.value);
    });

    document.querySelectorAll('.filter-btn').forEach(btn => {
      btn.addEventListener('click', (e) => {
        document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
        e.target.classList.add('active');
        sortSessions(e.target.dataset.sort);
      });
    });

    // Load sessions on page load
    loadAllSessions();
  </script>
</body>
</html>
