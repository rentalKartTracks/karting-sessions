<!DOCTYPE html>
<html>

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <meta http-equiv="Content-Security-Policy" content="
    default-src 'self';
    script-src 'self' https://www.youtube.com https://s.ytimg.com https://www.google.com https://static.doubleclick.net https://unpkg.com https://cdnjs.cloudflare.com 'unsafe-inline' 'unsafe-eval';
    style-src 'self' 'unsafe-inline';
    img-src 'self' data: https://i.ytimg.com https://www.google.com;
    frame-src https://www.youtube.com https://www.youtube-nocookie.com;
    font-src 'self';
    connect-src 'self' https://www.google.com https://www.youtube.com https://static.doubleclick.net wss: https:;
    object-src 'none';
    base-uri 'self';
    form-action 'self';
    frame-ancestors 'self';
  ">

  <title>Karting Session Viewer - Pro Optimized</title>

  <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

  <style>
    /* 1. Base Styles */
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #1e1e1e 0%, #2d2d2d 100%);
      color: #e0e0e0;
      min-height: 100vh;
      padding: 20px;
    }

    .container {
      max-width: 1400px;
      margin: 0 auto;
    }

    /* 2. Optimized Chart CSS (Layered Canvases) */
    .chart-wrapper {
      position: relative;
      height: 350px;
      width: 100%;
      background: #252525;
      border-radius: 8px;
      overflow: hidden;
      margin-top: 15px;
    }

    .chart-canvas {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
    }

    #lap-chart-overlay {
      pointer-events: none;
      z-index: 2;
    }

    #lap-chart-static {
      z-index: 1;
    }

    /* 3. Header & Stats */
    .header {
      background: linear-gradient(135deg, #d32f2f 0%, #f44336 100%);
      padding: 25px;
      border-radius: 12px;
      margin-bottom: 30px;
      box-shadow: 0 8px 32px rgba(211, 47, 47, 0.3);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(6, 1fr);
      gap: 20px;
      margin-bottom: 30px;
    }

    .stat-card {
      background: #2d2d2d;
      padding: 20px;
      border-radius: 12px;
      border-left: 4px solid #f44336;
    }

    .stat-label {
      color: #999;
      font-size: 0.8em;
      text-transform: uppercase;
      margin-bottom: 5px;
    }

    .stat-value {
      font-size: 1.6em;
      font-weight: bold;
    }

    .fastest-time {
      color: #ffd700;
    }

    /* 4. Video UI */
    .video-responsive {
      position: relative;
      padding-bottom: 56.25%;
      height: 0;
      background: #000;
      border-radius: 12px;
      overflow: hidden;
      margin-bottom: 20px;
    }

    .video-responsive iframe {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
    }

    /* 5. View Mode Logic */
    body.tv-mode {
      padding: 40px;
    }

    body.tv-mode .header {
      height: 120px;
    }

    body.tv-mode .stats-grid {
      grid-template-columns: repeat(3, 1fr);
    }

    body.tv-mode .comparison-container,
    body.tv-mode .socials {
      display: none;
    }

    .mode-switcher {
      background: rgba(0, 0, 0, 0.3);
      padding: 5px;
      border-radius: 20px;
      display: flex;
    }

    .mode-btn {
      padding: 8px 15px;
      border: none;
      background: none;
      color: white;
      cursor: pointer;
      border-radius: 15px;
      font-weight: bold;
    }

    .mode-btn.active {
      background: rgba(255, 255, 255, 0.2);
    }

    /* 6. Range Slider */
    #lap-selector-slider {
      width: 100%;
      margin: 20px 0;
      -webkit-appearance: none;
      height: 8px;
      background: #3d3d3d;
      border-radius: 4px;
    }

    #lap-selector-slider::-webkit-slider-thumb {
      -webkit-appearance: none;
      width: 22px;
      height: 22px;
      background: #f44336;
      border-radius: 50%;
      cursor: pointer;
    }

    .tooltip {
      position: absolute;
      background: rgba(0, 0, 0, 0.9);
      border: 1px solid #f44336;
      padding: 10px;
      border-radius: 5px;
      pointer-events: none;
      display: none;
      z-index: 100;
    }
  </style>
</head>

<body class="pc-mode">
  <div class="container">
    <div class="header">
      <div>
        <h1 id="driver" style="font-size: 2.2em;">Loading...</h1>
        <p id="session-date" style="opacity: 0.8;"></p>
      </div>
      <div class="mode-switcher">
        <button id="pc-mode-btn" class="mode-btn active" onclick="switchMode('pc')">PC</button>
        <button id="tv-mode-btn" class="mode-btn" onclick="switchMode('tv')">TV</button>
      </div>
    </div>

    <div class="stats-grid">
      <div class="stat-card">
        <div class="stat-label">Fastest</div>
        <div class="stat-value fastest-time" id="fastest">-</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">Average</div>
        <div class="stat-value" id="average">-</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">Consistency</div>
        <div class="stat-value" id="consistency">-</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">Track</div>
        <div class="stat-value" id="track">-</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">Kart</div>
        <div class="stat-value" id="kart">-</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">Laps</div>
        <div class="stat-value" id="total-laps">-</div>
      </div>
    </div>

    <div class="video-responsive">
      <div id="youtube-player"></div>
    </div>

    <div class="stat-card" style="border: none; background: #2d2d2d; padding: 25px;">
      <div style="display:flex; justify-content:space-between; align-items:center;">
        <h3 id="current-lap-display" style="color: #ffd700;">Lap 1</h3>
        <button onclick="nextLap()"
          style="padding: 8px 20px; background:#f44336; color:white; border:none; border-radius:5px; cursor:pointer; font-weight:bold;">Next
          Lap</button>
      </div>
      <input type="range" id="lap-selector-slider" min="1" max="1" value="1">

      <div class="chart-wrapper">
        <canvas id="lap-chart-static" class="chart-canvas"></canvas>
        <canvas id="lap-chart-overlay" class="chart-canvas"></canvas>
      </div>
    </div>

    <div id="qr-panel" class="stat-card" style="margin-top: 20px; text-align: center;">
      <h3 style="margin-bottom: 10px;">Remote Control</h3>
      <div id="qr-code" style="display: inline-block; background: white; padding: 10px; border-radius: 10px;"></div>
      <p id="peer-id-display" style="margin-top: 10px; font-family: monospace; font-size: 0.9em;"></p>
    </div>
  </div>

  <script>
    // --- State Management ---
    let player;
    let currentSessionData = null;
    let lapStartTimes = [];
    let chartMeta = { padding: 40, width: 0, height: 0, minTime: 0, maxTime: 0, timeRange: 0 };
    let peer = null;
    let connections = [];

    // --- Init ---
    document.addEventListener('DOMContentLoaded', () => {
      const urlParams = new URLSearchParams(window.location.search);
      const sessionId = urlParams.get('id') || 'demo';

      fetch(`sessions/${sessionId}.json`)
        .then(res => res.json())
        .then(data => {
          currentSessionData = data;
          initApp(data);
        })
        .catch(() => alert("Session not found."));
    });

    function initApp(data) {
      document.getElementById('driver').textContent = data.driver;
      document.getElementById('session-date').textContent = new Date(data.session_date).toLocaleDateString();
      document.getElementById('track').textContent = data.track.name;
      document.getElementById('kart').textContent = data.kart;

      const validLaps = data.laps.filter(l => l.lap !== null && l.time);
      document.getElementById('total-laps').textContent = validLaps.length;
      document.getElementById('fastest').textContent = data.fastest_lap || '--:--';

      // Setup Timing
      calculateLapTimings(data, validLaps);
      setupYoutube(data.video_url, data.video_start_time);

      // UI Components
      const slider = document.getElementById('lap-selector-slider');
      slider.max = validLaps.length;
      slider.oninput = (e) => seekToLap(parseInt(e.target.value));

      // Build Peer Connection
      initPeer();

      // Start Rendering
      drawStaticBackground();
      requestAnimationFrame(renderLoop);
    }

    // --- Optimized Chart Rendering (The core change) ---
    function drawStaticBackground() {
      const canvas = document.getElementById('lap-chart-static');
      const ctx = canvas.getContext('2d');
      const wrapper = canvas.parentElement;
      canvas.width = wrapper.clientWidth;
      canvas.height = wrapper.clientHeight;
      chartMeta.width = canvas.width;
      chartMeta.height = canvas.height;

      const validLaps = currentSessionData.laps.filter(l => l.lap !== null && l.time);
      const times = validLaps.map(l => parseTime(l.time));

      chartMeta.minTime = Math.min(...times) * 0.98;
      chartMeta.maxTime = Math.max(...times) * 1.02;
      chartMeta.timeRange = chartMeta.maxTime - chartMeta.minTime;

      ctx.clearRect(0, 0, canvas.width, canvas.height);

      // Draw Grid Lines
      ctx.strokeStyle = '#3d3d3d';
      ctx.lineWidth = 1;
      for (let i = 0; i <= 4; i++) {
        const y = chartMeta.padding + (i * (canvas.height - 2 * chartMeta.padding) / 4);
        ctx.beginPath();
        ctx.moveTo(chartMeta.padding, y);
        ctx.lineTo(canvas.width - chartMeta.padding, y);
        ctx.stroke();
      }

      // Draw Lap Lines
      ctx.strokeStyle = '#f44336';
      ctx.lineWidth = 3;
      ctx.lineJoin = 'round';
      ctx.beginPath();
      validLaps.forEach((lap, i) => {
        const coords = getPointCoords(i, parseTime(lap.time), validLaps.length);
        if (i === 0) ctx.moveTo(coords.x, coords.y);
        else ctx.lineTo(coords.x, coords.y);
      });
      ctx.stroke();

      // Draw Individual Points
      validLaps.forEach((lap, i) => {
        const coords = getPointCoords(i, parseTime(lap.time), validLaps.length);
        ctx.fillStyle = lap.best ? '#ffd700' : '#ff5252';
        ctx.beginPath();
        ctx.arc(coords.x, coords.y, lap.best ? 6 : 4, 0, Math.PI * 2);
        ctx.fill();
      });
    }

    // SMOOTH SLIDER: Runs at 60fps, but ONLY clears the overlay
    function renderLoop() {
      if (player && typeof player.getCurrentTime === 'function') {
        const vTime = player.getCurrentTime();
        updateDynamicOverlay(vTime);
      }
      requestAnimationFrame(renderLoop);
    }

    function updateDynamicOverlay(vTime) {
      const canvas = document.getElementById('lap-chart-overlay');
      const ctx = canvas.getContext('2d');
      const staticCanvas = document.getElementById('lap-chart-static');

      // Match sizing if changed
      if (canvas.width !== staticCanvas.width) {
        canvas.width = staticCanvas.width;
        canvas.height = staticCanvas.height;
      }

      ctx.clearRect(0, 0, canvas.width, canvas.height);

      const lapIndex = getCurrentLapIndex(vTime);
      const validLaps = currentSessionData.laps.filter(l => l.lap !== null);
      const total = validLaps.length;

      // Calculate X position
      const x = chartMeta.padding + (lapIndex * (canvas.width - 2 * chartMeta.padding) / (total - 1));

      // Draw vertical highlighter
      ctx.strokeStyle = 'rgba(255, 255, 255, 0.4)';
      ctx.setLineDash([5, 5]);
      ctx.beginPath();
      ctx.moveTo(x, 10);
      ctx.lineTo(x, canvas.height - 10);
      ctx.stroke();
      ctx.setLineDash([]);

      // Update UI text (Debounced via condition)
      const currentLapNum = lapIndex + 1;
      const display = document.getElementById('current-lap-display');
      if (display.innerText !== `Lap ${currentLapNum}`) {
        display.innerText = `Lap ${currentLapNum}`;
        document.getElementById('lap-selector-slider').value = currentLapNum;
      }
    }

    // --- YouTube & Controls ---
    function setupYoutube(url, startTime) {
      const videoId = url.split('v=')[1]?.split('&')[0];
      const tag = document.createElement('script');
      tag.src = "https://www.youtube.com/iframe_api";
      document.head.appendChild(tag);

      window.onYouTubeIframeAPIReady = () => {
        player = new YT.Player('youtube-player', {
          height: '100%', width: '100%', videoId: videoId,
          playerVars: { 'start': Math.floor(parseTime(startTime)), 'rel': 0 }
        });
      };
    }

    function seekToLap(lapNum) {
      const target = lapStartTimes.find(l => l.lap === lapNum);
      if (target && player) player.seekTo(target.startTime, true);
    }

    function nextLap() {
      const next = (getCurrentLapIndex(player.getCurrentTime()) + 2);
      if (next <= lapStartTimes.length) seekToLap(next);
    }

    // --- PeerJS Lifecycle (Optimized) ---
    function initPeer() {
      peer = new Peer();
      peer.on('open', (id) => {
        const url = `${window.location.origin}/remote.html?peerId=${id}`;
        document.getElementById('peer-id-display').textContent = `ID: ${id}`;
        new QRCode(document.getElementById("qr-code"), { text: url, width: 128, height: 128 });
      });
      peer.on('connection', (conn) => {
        connections.push(conn);
        conn.on('data', (data) => handleRemoteCommand(data));
      });
    }

    function handleRemoteCommand(data) {
      if (data === 'NEXT_LAP') nextLap();
      if (data === 'PLAY_PAUSE') {
        const state = player.getPlayerState();
        state === 1 ? player.pauseVideo() : player.playVideo();
      }
    }

    // --- Utility ---
    function parseTime(t) {
      if (!t) return 0;
      const p = t.split(':');
      return p.length === 2 ? parseInt(p[0]) * 60 + parseFloat(p[1]) : parseFloat(p[0]);
    }

    function calculateLapTimings(data, laps) {
      let cumulative = parseTime(data.video_start_time || "0:00");
      lapStartTimes = [{ lap: 1, startTime: cumulative }];
      for (let i = 0; i < laps.length - 1; i++) {
        cumulative += parseTime(laps[i].time);
        lapStartTimes.push({ lap: i + 2, startTime: cumulative });
      }
    }

    function getCurrentLapIndex(vTime) {
      for (let i = lapStartTimes.length - 1; i >= 0; i--) {
        if (vTime >= lapStartTimes[i].startTime) return i;
      }
      return 0;
    }

    function getPointCoords(idx, time, total) {
      const w = chartMeta.width - 2 * chartMeta.padding;
      const h = chartMeta.height - 2 * chartMeta.padding;
      return {
        x: chartMeta.padding + (idx * w / (total - 1)),
        y: chartMeta.padding + h - ((time - chartMeta.minTime) / chartMeta.timeRange * h)
      };
    }

    function switchMode(mode) {
      document.body.className = mode + '-mode';
      document.getElementById('pc-mode-btn').classList.toggle('active', mode === 'pc');
      document.getElementById('tv-mode-btn').classList.toggle('active', mode === 'tv');
      drawStaticBackground(); // Redraw on resize
    }

    // Handle back-forward cache and cleanup
    window.onpagehide = () => { if (peer) peer.destroy(); };
  </script>
</body>

</html>