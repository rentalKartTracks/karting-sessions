<!DOCTYPE html>
<html>
<head>
Â  <meta charset="UTF-8">
Â  <meta name="viewport" content="width=device-width, initial-scale=1.0">
Â  <title>Karting Session Viewer</title>

Â  <style>
Â  Â  * { margin: 0; padding: 0; box-sizing: border-box; }
Â  Â  body {
Â  Â  Â  font-family: 'Segoe UI', Tahoma, sans-serif;
Â  Â  Â  background: #1e1e1e;
Â  Â  Â  color: #e0e0e0;
Â  Â  Â  padding: 20px;
Â  Â  Â  min-height: 100vh;
Â  Â  }
Â  Â  .container { max-width: 1400px; margin: auto; }

Â  Â  .header {
Â  Â  Â  background: linear-gradient(135deg, #d32f2f, #f44336);
Â  Â  Â  padding: 25px;
Â  Â  Â  border-radius: 10px;
Â  Â  Â  margin-bottom: 25px;
Â  Â  Â  box-shadow: 0 8px 32px rgba(211,47,47,0.3);
Â  Â  }
Â  Â  .driver-name { font-size: 2.5em; font-weight: bold; }
Â  Â  .stats-grid {
Â  Â  Â  display: grid; gap: 20px;
Â  Â  Â  grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
Â  Â  Â  margin-bottom: 25px;
Â  Â  }
Â  Â  .stat-card {
Â  Â  Â  background: #2d2d2d;
Â  Â  Â  padding: 20px;
Â  Â  Â  border-radius: 12px;
Â  Â  Â  border-left: 4px solid #f44336;
Â  Â  }
Â  Â  .stat-label { color: #aaa; font-size: .9em; }
Â  Â  .stat-value { font-size: 1.8em; font-weight: bold; }
Â  Â  .fastest-time { color: #ffd700; }

Â  Â  .chart-container {
Â  Â  Â  background: #2d2d2d;
Â  Â  Â  padding: 25px;
Â  Â  Â  border-radius: 12px;
Â  Â  Â  margin-bottom:30px;
Â  Â  }
Â  Â  canvas { width:100%; height:300px; }
    .chart-title { font-size: 1.2em; font-weight: bold; margin-bottom: 15px; } /* Added styling for chart title */

Â  Â  .comparison-container {
Â  Â  Â  background:#2d2d2d;
Â  Â  Â  padding:25px;
Â  Â  Â  border-radius:12px;
Â  Â  Â  margin-top:35px;
Â  Â  }
Â  Â  .comparison-input {
Â  Â  Â  display:flex; gap:15px; margin-bottom:15px;
Â  Â  }
Â  Â  .comparison-input input {
Â  Â  Â  flex:1; padding:10px;
Â  Â  Â  background:#1e1e1e; border:2px solid #444;
Â  Â  Â  color:#eee; border-radius:8px;
Â  Â  }
Â  Â  .comparison-input button {
Â  Â  Â  background:#f44336; border:none;
Â  Â  Â  padding:10px 20px; border-radius:8px;
Â  Â  Â  font-weight:bold; cursor:pointer;
Â  Â  Â  transition:.2s;
Â  Â  }
Â  Â  .comparison-input button:hover {
Â  Â  Â  background:#d32f2f;
Â  Â  }

Â  Â  table { width:100%; border-collapse:collapse; margin-top:10px; }
Â  Â  th, td {
Â  Â  Â  padding:8px 10px; border-bottom:1px solid #444;
Â  Â  Â  text-align:center;
Â  Â  }
Â  Â  th { background:#333; }

Â  Â  .socials {
Â  Â  Â  margin-top:40px; text-align:center;
Â  Â  Â  background:#2d2d2d; padding:25px; border-radius:12px;
Â  Â  }
Â  Â  .socials a { margin:0 15px; color:#f44336; text-decoration:none; font-weight:bold; }
Â  Â  .socials a:hover { color:#ff5151; }
Â  </style>
</head>

<body>
<div class="container">

Â  <div class="header">
Â  Â  <div id="driver" class="driver-name"></div>
Â  Â  <div id="session-date"></div>
Â  </div>

Â  <div class="stats-grid">
Â  Â  <div class="stat-card">
Â  Â  Â  <div class="stat-label">Fastest Lap</div>
Â  Â  Â  <div id="fastest" class="stat-value fastest-time"></div>
Â  Â  </div>
Â  Â  <div class="stat-card">
Â  Â  Â  <div class="stat-label">Average Lap</div>
Â  Â  Â  <div id="average" class="stat-value"></div>
Â  Â  </div>
Â  Â  <div class="stat-card">
Â  Â  Â  <div class="stat-label">Consistency</div>
Â  Â  Â  <div id="consistency" class="stat-value"></div>
Â  Â  </div>
Â  Â  <div class="stat-card">
Â  Â  Â  <div class="stat-label">Track</div>
Â  Â  Â  <div class="stat-value"><a id="track-link" target="_blank"></a></div>
Â  Â  </div>
Â  Â  <div class="stat-card">
Â  Â  Â  <div class="stat-label">Configuration</div>
Â  Â  Â  <div id="track-config" class="stat-value"></div>
Â  Â  </div>
Â  Â  <div class="stat-card">
Â  Â  Â  <div class="stat-label">Kart</div>
Â  Â  Â  <div id="kart" class="stat-value"></div>
Â  Â  </div>
Â  Â  <div class="stat-card">
Â  Â  Â  <div class="stat-label">Total Laps</div>
Â  Â  Â  <div id="total-laps" class="stat-value"></div>
Â  Â  </div>
Â  </div>

Â  <div class="chart-container">
Â  Â  <div class="chart-title">ðŸ“ˆ Lap Time Progression (Current Session)</div>
Â  Â  <canvas id="lap-chart"></canvas>
Â  </div>

Â  <div class="comparison-container">
Â  Â  <h2>ðŸ”„ Compare Sessions</h2>
Â  Â  <div class="comparison-input">
Â  Â  Â  <input id="compare-id" placeholder="Enter session ID (example-session)">
Â  Â  Â  <button onclick="compareSession()">Compare</button>
Â  Â  </div>
Â  Â  <div class="chart-title">ðŸ“Š Session Comparison</div>
Â  Â  <canvas id="compare-chart" style="height:300px;"></canvas>
Â  Â  <div id="comparison-table"></div>
Â  </div>

Â  <div class="socials">
Â  Â  <strong>Follow:</strong>
Â  Â  <a id="ig" target="_blank">Instagram</a>
Â  Â  <a id="fb" target="_blank">Facebook</a>
Â  Â  <a id="web" target="_blank">Website</a>
Â  </div>

</div>

<script>
/* -------------------------------
Â  Â Utility Functions
-------------------------------- */
function parseTime(t){ let p=t.split(":"); return +p[0]*60 + +p[1]; }
function formatTime(s){ const m=Math.floor(s/60); const sec=(s%60).toFixed(3); return m?`${m}:${sec.padStart(6,"0")}`:`${sec}`; }
function calculateConsistency(t){ let avg=t.reduce((a,b)=>a+b)/t.length; let v=t.reduce((s,x)=>s+(x-avg)**2,0)/t.length; return Math.sqrt(v); }

/* -------------------------------
Â  Â Load Main Session
-------------------------------- */
let currentSession = null;
const params = new URLSearchParams(location.search);
const sessionId = params.get("id");

if (sessionId) { // Check if session ID exists before fetching
    fetch(`sessions/${sessionId}.json`).then(r=>r.json()).then(d=>{
    Â  currentSession = d;
    Â  renderSession(d);
    }).catch(e => {
        console.error("Error loading session:", e);
        // Display an error to the user if session loading fails
        document.getElementById("driver").textContent = "Error Loading Session";
        document.getElementById("session-date").textContent = "Please check the session ID in the URL.";
    });
} else {
    document.getElementById("driver").textContent = "No Session ID Provided";
    document.getElementById("session-date").textContent = "Append ?id=session-name to the URL to load a session.";
}


/* -------------------------------
Â  Â Draw Lap Data (Single Line)
-------------------------------- */
// Internal helper function to draw a single line, used by both drawLineChart and drawMultiLineChart
function drawSingleLine(ctx, laps, color, chartMeta) {
    const { pad, w, h, min, range } = chartMeta;
    const times = laps.map(l => parseTime(l.time));

    // Line
    ctx.strokeStyle=color; ctx.lineWidth=3;
    ctx.beginPath();
    times.forEach((time,i)=>{
        const x = pad + w * (i / (times.length - 1));
        const y = pad + h - ((time - min) / range) * h;
        i===0?ctx.moveTo(x,y):ctx.lineTo(x,y);
    });
    ctx.stroke();

    // Points
    times.forEach((time,i)=>{
        const l = laps[i];
        const x = pad + w * (i / (times.length - 1));
        const y = pad + h - ((time - min) / range) * h;
        ctx.fillStyle = l.best ? "#ffd700" : color;
        ctx.beginPath(); ctx.arc(x,y,5,0,6.28); ctx.fill();
    });
}

/* -------------------------------
Â  Â Draw Single Session Chart (with grid)
-------------------------------- */
function drawLineChart(canvas, laps, color="#f44336") {
Â  const ctx = canvas.getContext("2d");
Â  canvas.width = canvas.offsetWidth;
Â  canvas.height = canvas.offsetHeight;

Â  const pad=40; const w=canvas.width-pad*2; const h=canvas.height-pad*2;

Â  const times = laps.map(l=>parseTime(l.time));
Â  const min = Math.min(...times);
Â  const max = Math.max(...times);
Â  const range = max-min || 1;

Â  ctx.clearRect(0,0,canvas.width,canvas.height);

Â  // Grid
Â  ctx.strokeStyle="#333";
Â  for(let i=0;i<=5;i++){
Â  Â  let y=pad+h*i/5;
Â  Â  ctx.beginPath(); ctx.moveTo(pad,y); ctx.lineTo(pad+w,y); ctx.stroke();
Â  }

  const chartMeta = { pad, w, h, min, range };
  drawSingleLine(ctx, laps, color, chartMeta);

Â  return chartMeta;
}

/* -------------------------------
Â  Â Draw Comparison Chart (Multi-Line)
-------------------------------- */
function drawMultiLineChart(canvas, sessions) {
    const ctx = canvas.getContext("2d");
    canvas.width = canvas.offsetWidth;
    canvas.height = canvas.offsetHeight;

    const pad = 40; const w = canvas.width - pad * 2; const h = canvas.height - pad * 2;

    // 1. Calculate combined min/max for scaling
    const allTimes = sessions.flatMap(s => s.laps.map(l => parseTime(l.time)));
    if (allTimes.length === 0) return;

    const min = Math.min(...allTimes);
    const max = Math.max(...allTimes);
    const range = max - min || 1;

    ctx.clearRect(0, 0, canvas.width, canvas.height);

    // 2. Draw Grid (using combined min/max)
    ctx.strokeStyle = "#333";
    for (let i = 0; i <= 5; i++) {
        let y = pad + h * i / 5;
        ctx.beginPath(); ctx.moveTo(pad, y); ctx.lineTo(pad + w, y); ctx.stroke();
    }
    
    // Y-Axis Labels (Optional but good for comparison)
    ctx.fillStyle = "#aaa"; ctx.font = "10px sans-serif"; ctx.textAlign = "right";
    for (let i = 0; i <= 5; i++) {
        let y = pad + h * i / 5;
        let timeValue = max - (range * i / 5);
        ctx.fillText(formatTime(timeValue), pad - 5, y + 3);
    }
    ctx.textAlign = "center";
    ctx.fillText("Lap Number", pad + w/2, h + pad + 15);


    const chartMeta = { pad, w, h, min, range };
    
    // 3. Draw Each Session Line
    const colors = ["#f44336", "#4caf50", "#2196f3", "#ff9800"]; // Add more colors if needed
    sessions.forEach((s, index) => {
        drawSingleLine(ctx, s.laps, colors[index % colors.length], chartMeta);
    });

    return chartMeta;
}

/* -------------------------------
Â  Â Hover Tooltip (Only for Single Chart)
-------------------------------- */
function enableHoverTooltip(canvas, laps, chartMeta) {
Â  const ctx = canvas.getContext("2d");
Â  const rect = canvas.getBoundingClientRect();
Â  const { pad, w, h, min, range } = chartMeta;

 // Remove previous listener to avoid stacking up listeners
 canvas.onmousemove = null;

Â  canvas.onmousemove = e => {
Â  Â  const x = e.clientX - rect.left;
Â  Â  const y = e.clientY - rect.top;

Â  Â  // Redraw the chart to clear previous tooltip
Â  Â  drawLineChart(canvas, laps);

Â  Â  let closest = null;
Â  Â  laps.forEach((l,i)=>{
Â  Â  Â  const px = pad + w*(i/(laps.length-1));
Â  Â  Â  const py = pad + h - ((parseTime(l.time)-min)/range)*h;
Â  Â  Â  const dist = Math.hypot(x-px, y-py);
Â  Â  Â  if(!closest || dist < closest.dist) closest = { l, px, py, dist };
Â  Â  });

Â  Â  if(closest && closest.dist < 15){
Â  Â  Â  const text = `Lap ${closest.l.lap}: ${closest.l.time}`;
Â  Â  Â  ctx.fillStyle="rgba(0,0,0,0.8)";
Â  Â  Â  // Calculate text width dynamically
Â  Â  Â  const textWidth = ctx.measureText(text).width;
Â  Â  Â  ctx.fillRect(closest.px+10, closest.py-25, textWidth+12, 22);
Â  Â  Â  ctx.fillStyle="#fff";
Â  Â  Â  ctx.font = "12px sans-serif";
Â  Â  Â  ctx.fillText(text, closest.px+15, closest.py-9);
Â  Â  }
Â  };
}

/* -------------------------------
Â  Â Render Session UI
-------------------------------- */
function renderSession(d) {
Â  document.getElementById("driver").textContent = d.driver;
Â  document.getElementById("session-date").textContent = d.session_date;
Â  document.getElementById("kart").textContent = d.kart;

Â  document.getElementById("track-link").textContent = d.track.name;
Â  document.getElementById("track-link").href = d.track.maps_link;
Â  document.getElementById("track-config").textContent = d.track.configuration || "-";

Â  const laps = d.laps.filter(x=>x.lap!==null);
Â  document.getElementById("fastest").textContent = d.fastest_lap;
Â  document.getElementById("total-laps").textContent = laps.length;

Â  const times = laps.map(x=>parseTime(x.time));
Â  document.getElementById("average").textContent = formatTime(times.reduce((a,b)=>a+b)/times.length);

Â  const sd = calculateConsistency(times);
Â  document.getElementById("consistency").textContent = `Â±${sd.toFixed(3)}s`;

Â  // Chart
Â  const canvas = document.getElementById("lap-chart");
Â  const meta = drawLineChart(canvas, laps);
Â  enableHoverTooltip(canvas, laps, meta);

Â  // Social links
Â  document.getElementById("ig").href = d.socials.instagram;
Â  document.getElementById("fb").href = d.socials.facebook;
Â  document.getElementById("web").href = d.socials.website;
}

/* -------------------------------
Â  Â Comparison Mode (Overlay Chart)
-------------------------------- */
async function compareSession(){
Â  const id = document.getElementById("compare-id").value.trim();
Â  if(!id) return;
Â  if(!currentSession) {
Â  Â  document.getElementById("comparison-table").innerHTML = "<p style='color:#f44336'>Load a primary session first to compare.</p>";
Â  Â  return;
Â  }

Â  try{
Â  Â  const res = await fetch(`sessions/${id}.json`);
Â  Â  if (!res.ok) throw new Error("Session file not found");
Â  Â  const d2 = await res.json();

Â  Â  const laps1 = currentSession.laps.filter(l=>l.lap!==null).map(l => ({ ...l, driver: currentSession.driver }));
Â  Â  const laps2 = d2.laps.filter(l=>l.lap!==null).map(l => ({ ...l, driver: d2.driver }));

Â  Â  const c = document.getElementById("compare-chart");

    // Use the new multi-line chart function
Â  Â  drawMultiLineChart(c, [{laps: laps1, driver: currentSession.driver}, {laps: laps2, driver: d2.driver}]);


Â  Â  // Lap-by-lap table
Â  Â  let rows="";
Â  Â  const max = Math.max(laps1.length, laps2.length);

Â  Â  for(let i=0;i<max;i++){
Â  Â  Â  const l1 = laps1[i]?parseTime(laps1[i].time):null;
Â  Â  Â  const l2 = laps2[i]?parseTime(laps2[i].time):null;

Â  Â  Â  let diff = "-";
Â  Â  Â  if(l1!==null && l2!==null) {
Â  Â  Â  Â  const delta = l1 - l2;
Â  Â  Â  Â  const sign = delta > 0 ? "+" : "";
Â  Â  Â  Â  const color = delta < 0 ? "#4caf50" : (delta > 0 ? "#f44336" : "#eee");
Â  Â  Â  Â  diff = `<span style="color:${color}">${sign}${delta.toFixed(3)}s</span>`;
Â  Â  Â  }

Â  Â  Â  rows += `
Â  Â  Â  Â  <tr>
Â  Â  Â  Â  Â  <td>${i+1}</td>
Â  Â  Â  Â  Â  <td>${l1!==null?formatTime(l1):"-"}</td>
Â  Â  Â  Â  Â  <td>${l2!==null?formatTime(l2):"-"}</td>
Â  Â  Â  Â  Â  <td>${diff}</td>
Â  Â  Â  Â  Â  </tr>`;
Â  Â  }

Â  Â  document.getElementById("comparison-table").innerHTML = `
Â  Â  Â  <h3>Lap-by-Lap Comparison</h3>
Â  Â  Â  <div style="margin-bottom: 10px; font-size: 0.9em;">
Â  Â  Â  Â  <span style="color:#f44336;">&#9679; ${currentSession.driver}</span> vs
Â  Â  Â  Â  <span style="color:#4caf50;">&#9679; ${d2.driver}</span>
Â  Â  Â  </div>
Â  Â  Â  <table>
Â  Â  Â  Â  <thead>
Â  Â  Â  Â  Â  <tr>
Â  Â  Â  Â  Â  Â  <th>Lap</th>
Â  Â  Â  Â  Â  Â  <th style="color:#f44336;">${currentSession.driver}</th>
Â  Â  Â  Â  Â  Â  <th style="color:#4caf50;">${d2.driver}</th>
Â  Â  Â  Â  Â  Â  <th>Î” (${currentSession.driver} - ${d2.driver})</th>
Â  Â  Â  Â  Â  </tr>
Â  Â  Â  Â  </thead>
Â  Â  Â  Â  <tbody>${rows}</tbody>
Â  Â  Â  </table>
Â  Â  `;

Â  } catch (e) {
Â  Â  console.error("Comparison error:", e);
Â  Â  document.getElementById("comparison-table").innerHTML =
Â  Â  Â  "<p style='color:#f44336'>Error loading comparison session. Check the ID and ensure the file exists.</p>";
Â  }
}
</script>

</body>
</html>
