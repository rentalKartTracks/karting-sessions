<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Karting Session Viewer</title>

  <!-- YouTube IFrame API (loaded once) -->
  <script src="https://www.youtube.com/iframe_api"></script>

  <style>
    /* === GLOBAL RESET === */
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Segoe UI', Tahoma, sans-serif;
      background: linear-gradient(135deg, #1e1e1e 0%, #2d2d2d 100%);
      color: #e0e0e0;
      min-height: 100vh;
      padding: 20px;
    }

    .container {
      max-width: 1400px;
      margin: 0 auto;
    }

    /* === HEADER === */
    .header {
      background: linear-gradient(135deg, #d32f2f 0%, #f44336 100%);
      padding: 30px;
      border-radius: 12px;
      margin-bottom: 30px;
      box-shadow: 0 8px 32px rgba(211, 47, 47, 0.3);
    }

    .header-content {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 20px;
    }

    .driver-name {
      font-size: 2.5em;
      font-weight: bold;
    }

    .home-button {
      padding: 10px 20px;
      border-radius: 8px;
      border: 2px solid rgba(255, 255, 255, 0.3);
      text-decoration: none;
      color: #fff;
      font-weight: bold;
    }

    /* === STATS GRID === */
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(6, 1fr);
      gap: 20px;
      margin-bottom: 30px;
    }

    @media (max-width: 1200px) {
      .stats-grid {
        grid-template-columns: repeat(3, 1fr);
      }
    }

    @media (max-width: 768px) {
      .stats-grid {
        grid-template-columns: 1fr;
      }
    }

    .stat-card {
      background: #2d2d2d;
      padding: 20px;
      border-radius: 12px;
      border-left: 4px solid #f44336;
    }

    .stat-label {
      color: #999;
      font-size: 0.85em;
      text-transform: uppercase;
    }

    .stat-value {
      font-size: 1.6em;
      font-weight: bold;
    }

    .fastest-time {
      color: #ffd700;
    }

    /* === VIDEO === */
    .chart-container {
      background: #2d2d2d;
      padding: 30px;
      border-radius: 12px;
      margin-bottom: 30px;
    }

    .video-responsive {
      position: relative;
      padding-bottom: 56.25%;
      height: 0;
      overflow: hidden;
    }

    #youtube-player-container {
      position: absolute;
      inset: 0;
    }

    /* === SLIDER === */
    #video-sync-controls {
      margin-top: 20px;
      padding: 20px;
      background: #1e1e1e;
      border-radius: 8px;
    }
  </style>
</head>

<body>
  <div class="container">

    <div class="header">
      <div class="header-content">
        <div>
          <div class="driver-name" id="driver"></div>
          <div id="session-date"></div>
        </div>
        <a class="home-button" href="index.html">üè† Home</a>
      </div>
    </div>

    <div class="stats-grid">
      <div class="stat-card">
        <div class="stat-label">Fastest Lap</div>
        <div class="stat-value fastest-time" id="fastest"></div>
      </div>
      <div class="stat-card">
        <div class="stat-label">Average</div>
        <div class="stat-value" id="average"></div>
      </div>
      <div class="stat-card">
        <div class="stat-label">Consistency</div>
        <div class="stat-value" id="consistency"></div>
      </div>
      <div class="stat-card">
        <div class="stat-label">Track</div>
        <div class="stat-value"><a id="track-link" target="_blank"></a></div>
      </div>
      <div class="stat-card">
        <div class="stat-label">Kart</div>
        <div class="stat-value" id="kart"></div>
      </div>
      <div class="stat-card">
        <div class="stat-label">Total Laps</div>
        <div class="stat-value" id="total-laps"></div>
      </div>
    </div>

    <!-- VIDEO -->
    <div id="video-display-container" class="chart-container" style="display:none;">
      <div class="video-responsive">
        <div id="youtube-player-container"></div>
      </div>
    </div>

    <div id="video-sync-controls" style="display:none;">
      <strong>üé¨ Video Sync</strong>
      <div id="current-lap-display">Lap 1</div>
      <input type="range" id="lap-slider" min="1" value="1" step="1" style="width:100%;">
    </div>

  </div>

  <script>
    /* ===========================
       GLOBAL VIDEO STATE
    =========================== */
    let player = null;
    let pendingVideoConfig = null;
    let lapStartTimesInVideo = [];

    const lapSlider = document.getElementById('lap-slider');

    /* ===========================
       YOUTUBE API CALLBACK
    =========================== */
    window.onYouTubeIframeAPIReady = function () {
      if (!pendingVideoConfig) return;

      const { videoId, startTime } = pendingVideoConfig;

      player = new YT.Player('youtube-player-container', {
        videoId,
        playerVars: {
          start: startTime,
          rel: 0,
          modestbranding: 1,
          origin: location.origin
        },
        events: {
          onReady: () => syncVideoToLap(1)
        }
      });
    };

    /* ===========================
       VIDEO HELPERS
    =========================== */
    function extractYouTubeId(url) {
      const m = url.match(/(?:v=|\/)([0-9A-Za-z_-]{11})/);
      return m ? m[1] : null;
    }

    function parseTime(t) {
      if (!t) return 0;
      const [m, s] = t.split(':');
      return (+m || 0) * 60 + (+s || 0);
    }

    function renderVideo(videoUrl, videoStartTime, laps) {
      if (!videoUrl) return;

      const videoId = extractYouTubeId(videoUrl);
      if (!videoId) return;

      document.getElementById('video-display-container').style.display = 'block';
      document.getElementById('video-sync-controls').style.display = 'block';

      pendingVideoConfig = {
        videoId,
        startTime: parseTime(videoStartTime)
      };

      calculateLapStartTimes(laps, videoStartTime);

      if (window.YT && YT.Player) {
        window.onYouTubeIframeAPIReady();
      }
    }

    function calculateLapStartTimes(laps, startTime) {
      lapStartTimesInVideo = [];
      let t = parseTime(startTime);
      laps.forEach(l => {
        lapStartTimesInVideo.push(t);
        t += parseTime(l.time);
      });
      lapSlider.max = laps.length;
    }

    function syncVideoToLap(lap) {
      if (!player) return;
      const t = lapStartTimesInVideo[lap - 1];
      if (t != null) {
        player.seekTo(t, true);
        player.playVideo();
        document.getElementById('current-lap-display').textContent = `Lap ${lap}`;
      }
    }

    lapSlider.addEventListener('input', e => syncVideoToLap(+e.target.value));

    /* ===========================
       SESSION LOAD
    =========================== */
    const sessionId = new URLSearchParams(location.search).get('id');

    fetch(`sessions/${sessionId}.json`)
      .then(r => r.json())
      .then(data => {
        document.getElementById('driver').textContent = data.driver;
        document.getElementById('kart').textContent = data.kart;
        document.getElementById('track-link').textContent = data.track.name;
        document.getElementById('track-link').href = data.track.maps_link;
        document.getElementById('session-date').textContent =
          new Date(data.session_date).toLocaleDateString();

        const laps = data.laps.filter(l => l.time);
        document.getElementById('total-laps').textContent = laps.length;

        const times = laps.map(l => parseTime(l.time));
        document.getElementById('fastest').textContent =
          Math.min(...times).toFixed(3) + 's';
        document.getElementById('average').textContent =
          (times.reduce((a, b) => a + b, 0) / times.length).toFixed(3) + 's';

        renderVideo(data.video_url, data.video_start_time, laps);
      });
  </script>
</body>

</html>