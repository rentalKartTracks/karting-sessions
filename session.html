<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="Content-Security-Policy"
    content="default-src 'self'; script-src 'self' https://www.youtube.com https://s.ytimg.com https://www.google.com https://static.doubleclick.net https://unpkg.com https://cdnjs.cloudflare.com 'unsafe-inline' 'unsafe-eval'; style-src 'self' 'unsafe-inline'; img-src 'self' data: https://i.ytimg.com https://www.google.com; frame-src https://www.youtube.com https://www.youtube-nocookie.com; font-src 'self'; connect-src 'self' https://www.google.com https://www.youtube.com https://static.doubleclick.net wss: https:; object-src 'none'; base-uri 'self'; form-action 'self'; frame-ancestors 'self';">
  <meta http-equiv="X-XSS-Protection" content="1; mode=block">
  <meta http-equiv="X-Content-Type-Options" content="nosniff">
  <title>Karting Session Viewer</title>
  <link rel="preconnect" href="https://www.youtube.com">
  <link rel="preconnect" href="https://s.ytimg.com">
  <link rel="preconnect" href="https://www.google.com">
  <link rel="preconnect" href="https://unpkg.com">
  <link rel="preconnect" href="https://cdnjs.cloudflare.com">
  <link rel="stylesheet" href="css/common.css">
  <link rel="stylesheet" href="css/session.css">
  <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
</head>

<body>
  <div class="container">
    <!-- Visible Error Handler -->
    <div id="global-error-display"
      style="display:none; position:fixed; top:0; left:0; right:0; background:#f44336; color:white; padding:20px; z-index:9999; text-align:center; font-family:sans-serif; font-weight:bold;">
      <span id="global-error-text"></span>
      <button onclick="this.parentElement.style.display='none'"
        style="float:right; background:none; border:none; color:white; font-size:20px; cursor:pointer;">&times;</button>
    </div>
    <script>
      window.onerror = function (msg, url, line, col, error) {
        var display = document.getElementById('global-error-display');
        var text = document.getElementById('global-error-text');
        if (display && text) {
          display.style.display = 'block';
          text.textContent = 'Msg: ' + msg + ' | Line: ' + line;
        }
        return false;
      };
      window.addEventListener('unhandledrejection', function (event) {
        var display = document.getElementById('global-error-display');
        var text = document.getElementById('global-error-text');
        if (display && text) {
          display.style.display = 'block';
          text.textContent = 'Unhandled Promise Rejection: ' + event.reason;
        }
      });
    </script>

    <!-- Header -->
    <header class="header">
      <div class="header-content">
        <div class="header-info">
          <h1 class="driver-name" id="driver">Loading...</h1>
          <div class="session-meta">
            <span class="session-meta-item" id="session-date">
              <span>ğŸ“…</span>
              <span>Loading...</span>
            </span>
            <span class="session-meta-item" id="session-track">
              <span>ğŸ</span>
              <span>Loading...</span>
            </span>
            <span class="session-meta-item pc-only" id="session-uuid-container" style="display: none;">
              <span>ğŸ†”</span>
              <span id="session-uuid-display" class="uuid-text"></span>
              <button class="copy-btn" id="copy-uuid-btn" onclick="copySessionUUID()" title="Copy Session ID">
                ğŸ“‹
              </button>
            </span>
          </div>
        </div>
        <div class="header-actions">
          <a href="index.html" class="btn btn-primary btn-icon" title="Return to home" aria-label="Return to home">
            <span>ğŸ </span>
          </a>
          <div class="mode-switcher" role="group" aria-label="View mode switcher">
            <button class="mode-btn active" id="pc-mode-btn" onclick="switchMode('pc')" title="PC Mode"
              aria-label="Switch to PC Mode">
              <span>ğŸ’»</span>
              <span class="mode-text">PC</span>
            </button>
            <button class="mode-btn" id="tv-mode-btn" onclick="switchMode('tv')" title="TV Mode"
              aria-label="Switch to TV Mode">
              <span>ğŸ“º</span>
              <span class="mode-text">TV</span>
            </button>
          </div>
        </div>
      </div>
    </header>

    <!-- Stats Grid -->
    <section class="stats-grid" id="stats-grid" aria-label="Session statistics">
      <!-- Stats will be populated by JavaScript -->
    </section>

    <!-- Video Section -->
    <section class="video-section" id="video-section" style="display:none;">
      <!-- Video Layout Toolbar -->
      <div class="video-toolbar" id="video-toolbar" style="display: none;">
        <div class="layout-selector">
          <button class="layout-btn active" data-layout="single" onclick="changeVideoLayout('single')"
            title="Single View">
            <span class="layout-icon layout-icon-single"></span>
          </button>
          <button class="layout-btn" data-layout="dual" onclick="changeVideoLayout('dual')" title="Dual View">
            <span class="layout-icon layout-icon-dual"></span>
          </button>
          <button class="layout-btn" data-layout="main-side" onclick="changeVideoLayout('main-side')"
            title="Main + Side">
            <span class="layout-icon layout-icon-main-side"></span>
          </button>
          <button class="layout-btn" data-layout="grid" onclick="changeVideoLayout('grid')" title="Grid View">
            <span class="layout-icon layout-icon-grid"></span>
          </button>
          <button class="layout-btn" data-layout="pip" onclick="changeVideoLayout('pip')" title="Picture in Picture">
            <span class="layout-icon layout-icon-pip"></span>
          </button>
        </div>
        <div class="video-selector-toggle">
          <button class="btn btn-sm btn-secondary" onclick="toggleVideoSelector()" id="video-selector-btn">
            <span>ğŸ“¹</span>
            <span>Select Videos</span>
          </button>
        </div>
      </div>

      <!-- Video Selector Panel (Hidden by default) -->
      <div class="video-selector-panel" id="video-selector-panel" style="display: none;">
        <div class="panel-header">
          <h4>Active Videos (Max 4)</h4>
          <button onclick="toggleVideoSelector()" class="close-btn">&times;</button>
        </div>
        <div class="video-list" id="active-video-list">
          <!-- Populated by JS -->
        </div>
      </div>

      <div class="video-grid" id="video-grid">
        <!-- Videos will be dynamically injected here -->
      </div>

      <!-- Unified Playback Controls -->
      <div class="playback-controls">
        <div class="controls-wrapper">
          <div class="controls-top">
            <button class="control-btn" onclick="previousLap()" aria-label="Previous lap">
              <span>â®ï¸</span>
              <span>Previous</span>
            </button>
            <button class="control-btn play-btn" id="play-pause-btn" onclick="togglePlayPause()"
              aria-label="Play/Pause">
              <span id="play-icon">â–¶ï¸</span>
              <span id="play-text">Play</span>
            </button>
            <button class="control-btn" onclick="nextLap()" aria-label="Next lap">
              <span>â­ï¸</span>
              <span>Next</span>
            </button>
          </div>

        </div>
      </div>
    </section>

    <!-- QR Panel (Phone Remote) -->
    <div class="qr-panel" id="qr-panel">
      <div class="qr-header">
        <h3>
          <span class="status-indicator"></span>
          <span id="connection-status">ğŸ“± Phone Remote Control</span>
        </h3>
        <button class="qr-toggle-btn" onclick="toggleQRPanel()" aria-label="Toggle QR panel">
          <span id="qr-toggle-icon">â–¼</span>
        </button>
      </div>
      <div class="qr-content">
        <p class="qr-instructions">
          Scan this QR code with your phone to control video playback remotely.
        </p>
        <div class="qr-code-wrapper">
          <div id="qr-code"></div>
          <div class="remote-url" id="remote-url">Generating...</div>
        </div>
        <div class="connection-stats">
          <div class="connection-stat">
            <div class="connection-stat-label">Status</div>
            <div class="connection-stat-value" id="peer-status">Initializing...</div>
          </div>
          <div class="connection-stat">
            <div class="connection-stat-label">Connected</div>
            <div class="connection-stat-value" id="connected-count">0</div>
          </div>
        </div>
      </div>
    </div>

    <!-- TV Mode Controls -->
    <section class="tv-controls-section chart-container">
      <div class="chart-title">ğŸ® Remote Controls</div>
      <div class="tv-controls-grid">
        <button class="tv-big-btn" onclick="sendCommandToRemote('PREV_LAP')" aria-label="Previous lap">
          <span>â®ï¸</span>
          <span>Prev Lap</span>
        </button>
        <button class="tv-big-btn" onclick="sendCommandToRemote('PLAY_PAUSE')" aria-label="Play/Pause">
          <span id="play-icon-tv">â–¶ï¸</span>
          <span>Play/Pause</span>
        </button>
        <button class="tv-big-btn" onclick="sendCommandToRemote('NEXT_LAP')" aria-label="Next lap">
          <span>â­ï¸</span>
          <span>Next Lap</span>
        </button>
      </div>
    </section>

    <!-- Chart Container -->
    <section class="chart-container detailed-chart" aria-label="Lap time progression">
      <div class="chart-title">
        <span>ğŸ“ˆ Lap Time Progression</span>
      </div>
      <div class="line-chart">
        <canvas id="lap-chart" class="chart-canvas"></canvas>
      </div>
      <div id="chart-legend" class="legend" role="list" aria-label="Chart legend">
        <!-- Legend items populated by JavaScript -->
      </div>
    </section>

    <!-- Comparison Section (PC Mode Only) -->
    <section class="comparison-section" id="comparison-section">
      <div class="comparison-header">
        <div class="chart-title">
          <span>ğŸ”„ Compare Sessions</span>
          <button class="share-btn" id="share-btn" onclick="shareCompareLink()">
            <span>ğŸ”—</span>
            <span>Share</span>
          </button>
        </div>
        <div class="comparison-input-wrapper">
          <input type="text" id="compare-id-input" class="comparison-input"
            placeholder="Search session ID or driver name..." aria-label="Search sessions to compare"
            autocomplete="off">
          <div id="autocomplete-results" class="autocomplete-list" style="display:none;" role="listbox">
            <!-- Autocomplete items populated by JavaScript -->
          </div>
          <button class="btn btn-primary" onclick="compareSession()">
            <span>ğŸ”</span>
            <span>Compare</span>
          </button>
          <button class="btn btn-secondary" onclick="clearComparison()">
            <span>âœ–ï¸</span>
            <span>Clear</span>
          </button>
        </div>
      </div>
      <div class="comparison-results" id="comparison-results">
        <div class="comparison-grid" id="comparison-grid">
          <!-- Comparison cards populated by JavaScript -->
        </div>
      </div>
    </section>

    <!-- Footer (Social Links) -->
    <footer class="footer">
      <strong>Follow us:</strong>
      <a href="https://www.instagram.com/helmet.cam.heroes/" target="_blank" rel="noopener noreferrer">
        Instagram
      </a>
      <a href="https://www.facebook.com/Helmet.Cam.Heroes" target="_blank" rel="noopener noreferrer">
        Facebook
      </a>
      <a href="https://www.youtube.com/@HelmetCamHeroes" target="_blank" rel="noopener noreferrer">
        YouTube
      </a>
    </footer>
  </div>

  <!-- Tooltip -->
  <div id="chart-tooltip" class="tooltip" role="tooltip" aria-hidden="true">
    <!-- Tooltip content populated by JavaScript -->
  </div>

  <!-- Scripts will continue in Part 4 -->
  <script src="js/session.js"></script>
</body>

</html>