<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Karting Session Viewer</title>

  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: 'Segoe UI', Tahoma, sans-serif;
      background: #1e1e1e;
      color: #e0e0e0;
      padding: 20px;
      min-height: 100vh;
    }
    .container { max-width: 1400px; margin: auto; }

    .header {
      background: linear-gradient(135deg, #d32f2f, #f44336);
      padding: 25px;
      border-radius: 10px;
      margin-bottom: 25px;
      box-shadow: 0 8px 32px rgba(211,47,47,0.3);
    }
    .driver-name { font-size: 2.5em; font-weight: bold; }
    .stats-grid {
      display: grid; gap: 20px;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      margin-bottom: 25px;
    }
    .stat-card {
      background: #2d2d2d;
      padding: 20px;
      border-radius: 12px;
      border-left: 4px solid #f44336;
    }
    .stat-label { color: #aaa; font-size: .9em; }
    .stat-value { font-size: 1.8em; font-weight: bold; }
    .fastest-time { color: #ffd700; }

    .chart-container {
      background: #2d2d2d;
      padding: 25px;
      border-radius: 12px;
      margin-bottom:30px;
    }
    canvas { width:100%; height:300px; }
    .chart-title { font-size: 1.2em; font-weight: bold; margin-bottom: 15px; }

    .comparison-container {
      background:#2d2d2d;
      padding:25px;
      border-radius:12px;
      margin-top:35px;
    }
    .comparison-input {
      display:flex; gap:15px; margin-bottom:15px;
    }
    .comparison-input input {
      flex:1; padding:10px;
      background:#1e1e1e; border:2px solid #444;
      color:#eee; border-radius:8px;
    }
    .comparison-input button {
      background:#f44336; border:none;
      padding:10px 20px; border-radius:8px;
      font-weight:bold; cursor:pointer;
      transition:.2s;
    }
    .comparison-input button:hover { background:#d32f2f; }

    table { width:100%; border-collapse:collapse; margin-top:10px; }
    th, td {
      padding:8px 10px; border-bottom:1px solid #444;
      text-align:center;
    }
    th { background:#333; }

    .socials {
      margin-top:40px; text-align:center;
      background:#2d2d2d; padding:25px; border-radius:12px;
    }
    .socials a { margin:0 15px; color:#f44336; text-decoration:none; font-weight:bold; }
    .socials a:hover { color:#ff5151; }
  </style>
</head>

<body>
<div class="container">

  <div class="header">
    <div id="driver" class="driver-name"></div>
    <div id="session-date"></div>
  </div>

  <div class="stats-grid">
    <div class="stat-card">
      <div class="stat-label">Fastest Lap</div>
      <div id="fastest" class="stat-value fastest-time"></div>
    </div>
    <div class="stat-card">
      <div class="stat-label">Average Lap</div>
      <div id="average" class="stat-value"></div>
    </div>
    <div class="stat-card">
      <div class="stat-label">Consistency</div>
      <div id="consistency" class="stat-value"></div>
    </div>
    <div class="stat-card">
      <div class="stat-label">Track</div>
      <div class="stat-value"><a id="track-link" target="_blank"></a></div>
    </div>
    <div class="stat-card">
      <div class="stat-label">Configuration</div>
      <div id="track-config" class="stat-value"></div>
    </div>
    <div class="stat-card">
      <div class="stat-label">Kart</div>
      <div id="kart" class="stat-value"></div>
    </div>
    <div class="stat-card">
      <div class="stat-label">Total Laps</div>
      <div id="total-laps" class="stat-value"></div>
    </div>
  </div>

  <div class="chart-container">
    <div class="chart-title">ðŸ“ˆ Lap Time Progression (Current Session)</div>
    <canvas id="lap-chart"></canvas>
  </div>

  <div class="comparison-container">
    <h2>ðŸ”„ Compare Sessions</h2>
    <div class="comparison-input">
      <input id="compare-id" placeholder="Enter session ID (example-session)">
      <button onclick="compareSession()">Compare</button>
    </div>
    <div class="chart-title">ðŸ“Š Session Comparison</div>
    <canvas id="compare-chart" style="height:300px;"></canvas>
    <div id="comparison-table"></div>
  </div>

  <div class="socials">
    <strong>Follow:</strong>
    <a id="ig" target="_blank">Instagram</a>
    <a id="fb" target="_blank">Facebook</a>
    <a id="web" target="_blank">Website</a>
  </div>

</div>

<script>
/* -------------------------------
   Utility Functions
-------------------------------- */
function parseTime(t){ let p=t.split(":"); return +p[0]*60 + +p[1]; }
function formatTime(s){ const m=Math.floor(s/60); const sec=(s%60).toFixed(3); return m?`${m}:${sec.padStart(6,"0")}`:`${sec}`; }
function calculateConsistency(t){ let avg=t.reduce((a,b)=>a+b)/t.length; let v=t.reduce((s,x)=>s+(x-avg)**2,0)/t.length; return Math.sqrt(v); }

/* -------------------------------
   Load Main Session
-------------------------------- */
let currentSession = null;
const params = new URLSearchParams(location.search);
const sessionId = params.get("id");

if (sessionId) {
    fetch(`sessions/${sessionId}.json`).then(r=>r.json()).then(d=>{
      currentSession = d;
      renderSession(d);
    }).catch(e => {
        console.error("Error loading session:", e);
        document.getElementById("driver").textContent = "Error Loading Session";
        document.getElementById("session-date").textContent = "Please check the session ID in the URL.";
    });
} else {
    document.getElementById("driver").textContent = "No Session ID Provided";
    document.getElementById("session-date").textContent = "Append ?id=session-name to the URL to load a session.";
}

/* -------------------------------
   Draw Lap Data (Single Line)
-------------------------------- */
function drawSingleLine(ctx, laps, color, chartMeta) {
    const { pad, w, h, min, range } = chartMeta;
    const times = laps.map(l => parseTime(l.time));

    ctx.strokeStyle=color; ctx.lineWidth=3;
    ctx.beginPath();
    times.forEach((time,i)=>{
        const x = pad + w * (i / (times.length - 1));
        const y = pad + h - ((time - min) / range) * h;
        i===0?ctx.moveTo(x,y):ctx.lineTo(x,y);
    });
    ctx.stroke();

    times.forEach((time,i)=>{
        const l = laps[i];
        const x = pad + w * (i / (laps.length - 1));
        const y = pad + h - ((time - min) / range) * h;
        ctx.fillStyle = l.best ? "#ffd700" : color;
        ctx.beginPath(); ctx.arc(x,y,5,0,6.28); ctx.fill();
    });
}

/* -------------------------------
   Draw Single Session Chart
-------------------------------- */
function drawLineChart(canvas, laps, color="#f44336") {
  const ctx = canvas.getContext("2d");
  canvas.width = canvas.offsetWidth;
  canvas.height = canvas.offsetHeight;

  const pad=40; const w=canvas.width-pad*2; const h=canvas.height-pad*2;

  const times = laps.map(l=>parseTime(l.time));
  const min = Math.min(...times);
  const max = Math.max(...times);
  const range = max-min || 1;

  ctx.clearRect(0,0,canvas.width,canvas.height);

  ctx.strokeStyle="#333";
  for(let i=0;i<=5;i++){
    let y=pad+h*i/5;
    ctx.beginPath(); ctx.moveTo(pad,y); ctx.lineTo(pad+w,y); ctx.stroke();
  }

  const chartMeta = { pad, w, h, min, range };
  drawSingleLine(ctx, laps, color, chartMeta);

  return chartMeta;
}

/* -------------------------------
   Hover Tooltip
-------------------------------- */
function enableHoverTooltip(canvas, laps, chartMeta) {
  const ctx = canvas.getContext("2d");
  const rect = canvas.getBoundingClientRect();
  const { pad, w, h, min, range } = chartMeta;

  canvas.onmousemove = null;

  canvas.onmousemove = e => {
    const x = e.clientX - rect.left;
    const y = e.clientY - rect.top;

    drawLineChart(canvas, laps);

    let closest = null;
    laps.forEach((l,i)=>{
      const px = pad + w*(i/(laps.length-1));
      const py = pad + h - ((parseTime(l.time)-min)/range)*h;
      const dist = Math.hypot(x-px, y-py);
      if(!closest || dist < closest.dist) closest = { l, px, py, dist };
    });

    if(closest && closest.dist < 15){
      const text = `Lap ${closest.l.lap}: ${closest.l.time}`;
      ctx.fillStyle="rgba(0,0,0,0.8)";
      const textWidth = ctx.measureText(text).width;
      ctx.fillRect(closest.px+10, closest.py-25, textWidth+12, 22);
      ctx.fillStyle="#fff";
      ctx.font = "12px sans-serif";
      ctx.fillText(text, closest.px+15, closest.py-9);
    }
  };
}

/* -------------------------------
   Render Session UI
-------------------------------- */
function renderSession(d) {
  document.getElementById("driver").textContent = d.driver;
  document.getElementById("session-date").textContent = d.session_date;
  document.getElementById("kart").textContent = d.kart;

  document.getElementById("track-link").textContent = d.track.name;
  document.getElementById("track-link").href = d.track.maps_link;
  document.getElementById("track-config").textContent = d.track.configuration || "-";

  const laps = d.laps.filter(x=>x.lap!==null);
  document.getElementById("fastest").textContent = d.fastest_lap;
  document.getElementById("total-laps").textContent = laps.length;

  const times = laps.map(x=>parseTime(x.time));
  document.getElementById("average").textContent = formatTime(times.reduce((a,b)=>a+b)/times.length);

  const sd = calculateConsistency(times);
  document.getElementById("consistency").textContent = `Â±${sd.toFixed(3)}s`;

  const canvas = document.getElementById("lap-chart");
  const meta = drawLineChart(canvas, laps);
  enableHoverTooltip(canvas, laps, meta);

  document.getElementById("ig").href = d.socials.instagram;
  document.getElementById("fb").href = d.socials.facebook;
  document.getElementById("web").href = d.socials.website;
}

/* -------------------------------
   Comparison Mode
-------------------------------- */
async function compareSession(){
  const id = document.getElementById("compare-id").value.trim();
  if(!id) return;
  if(!currentSession) {
    document.getElementById("comparison-table").innerHTML = "<p style='color:#f44336'>Load a primary session first to compare.</p>";
    return;
  }

  try{
    const res = await fetch(`sessions/${id}.json`);
    if (!res.ok) throw new Error("Session file not found");
    const d2 = await res.json();

    const laps1 = currentSession.laps.filter(l=>l.lap!==null).map(l => ({ ...l, driver: currentSession.driver }));
    const laps2 = d2.laps.filter(l=>l.lap!==null).map(l => ({ ...l, driver: d2.driver }));

    const c = document.getElementById("compare-chart");
    drawMultiLineChart(c, [{laps: laps1, driver: currentSession.driver}, {laps: laps2, driver: d2.driver}]);

    let rows="";
    const max = Math.max(laps1.length, laps2.length);
    for(let i=0;i<max;i++){
      const l1 = laps1[i]?parseTime(laps1[i].time):null;
      const l2 = laps2[i]?parseTime(laps2[i].time):null;

      let diff = "-";
      if(l1!==null && l2!==null) {
        const delta = l1 - l2;
        const sign = delta > 0 ? "+" : "";
        const color = delta < 0 ? "#4caf50" : (delta > 0 ? "#f44336" : "#eee");
        diff = `<span style="color:${color}">${sign}${delta.toFixed(3)}s</span>`;
      }

      rows += `
        <tr>
          <td>${i+1}</td>
          <td>${l1!==null?formatTime(l1):"-"}</td>
          <td>${l2!==null?formatTime(l2):"-"}</td>
          <td>${diff}</td>
          </tr>`;
    }

    document.getElementById("comparison-table").innerHTML = `
      <h3>Lap-by-Lap Comparison</h3>
      <div style="margin-bottom: 10px; font-size: 0.9em;">
        <span style="color:#f44336;">&#9679; ${currentSession.driver}</span> vs
        <span style="color:#4caf50;">&#9679; ${d2.driver}</span>
      </div>
      <table>
        <thead>
          <tr>
            <th>Lap</th>
            <th style="color:#f44336;">${currentSession.driver}</th>
            <th style="color:#4caf50;">${d2.driver}</th>
            <th>Î” (${currentSession.driver} - ${d2.driver})</th>
          </tr>
        </thead>
        <tbody>${rows}</tbody>
      </table>
    `;
  } catch (e) {
    console.error("Comparison error:", e);
    document.getElementById("comparison-table").innerHTML =
      "<p style='color:#f44336'>Error loading comparison session. Check the ID and ensure the file exists.</p>";
  }
}

/* -------------------------------
   Multi-Line Chart (for Comparison)
-------------------------------- */
function drawMultiLineChart(canvas, sessions) {
    const ctx = canvas.getContext("2d");
    canvas.width = canvas.offsetWidth;
    canvas.height = canvas.offsetHeight;

    const pad = 40; const w = canvas.width - pad * 2; const h = canvas.height - pad * 2;

    const allTimes = sessions.flatMap(s => s.laps.map(l => parseTime(l.time)));
    if (allTimes.length === 0) return;

    const min = Math.min(...allTimes);
    const max = Math.max(...allTimes);
    const range = max - min || 1;

    ctx.clearRect(0, 0, canvas.width, canvas.height);

    ctx.strokeStyle = "#333";
    for (let i = 0; i <= 5; i++) {
        let y = pad + h * i / 5;
        ctx.beginPath(); ctx.moveTo(pad, y); ctx.lineTo(pad + w, y); ctx.stroke();
    }

    ctx.fillStyle = "#aaa"; ctx.font = "10px sans-serif"; ctx.textAlign = "right";
    for (let i = 0; i <= 5; i++) {
        let y = pad + h * i / 5;
        let timeValue = max - (range * i / 5);
        ctx.fillText(formatTime(timeValue), pad - 5, y + 3);
    }
    ctx.textAlign = "center";
    ctx.fillText("Lap Number", pad + w/2, h + pad + 15);

    const chartMeta = { pad, w, h, min, range };
    const colors = ["#f44336", "#4caf50", "#2196f3", "#ff9800"];
    sessions.forEach((s, index) => {
        drawSingleLine(ctx, s.laps, colors[index % colors.length], chartMeta);
    });

    return chartMeta;
}
</script>

</body>
</html>
