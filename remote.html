<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Karting Remote</title>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <style>
        body {
            font-family: sans-serif;
            background: #121212;
            color: white;
            text-align: center;
            padding: 20px;
        }

        .stat-card {
            background: #1e1e1e;
            padding: 20px;
            border-radius: 15px;
            margin: 10px;
            border-bottom: 4px solid #f44336;
        }

        .label {
            color: #888;
            font-size: 0.8em;
            text-transform: uppercase;
        }

        .value {
            font-size: 2em;
            font-weight: bold;
            margin: 5px 0;
        }

        input[type=range] {
            width: 100%;
            height: 60px;
            accent-color: #f44336;
        }

        .status-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            display: inline-block;
            background: #f44336;
        }

        .connected .status-dot {
            background: #4caf50;
        }
    </style>
</head>

<body id="body">
    <div style="margin-bottom: 30px;">
        <span class="status-dot"></span> <span id="status">Connecting...</span>
    </div>

    <div class="stat-card">
        <div class="label">Current Lap</div>
        <div id="cur-lap" class="value">--</div>
    </div>

    <div class="stat-card">
        <div class="label">Lap Time</div>
        <div id="cur-time" class="value">--:--</div>
    </div>

    <div style="margin-top: 40px; padding: 0 10px;">
        <div class="label">Drag to seek video</div>
        <input type="range" id="seek-slider" min="0" max="100" value="0">
    </div>

    <script>
        const params = new URLSearchParams(window.location.search);
        const hostId = params.get('host');
        const peer = new Peer();
        let conn;

        peer.on('open', () => {
            if (hostId) {
                conn = peer.connect(hostId);
                setupEvents();
            } else {
                document.getElementById('status').innerText = "No Host ID found in URL";
            }
        });

        function setupEvents() {
            conn.on('open', () => {
                document.getElementById('status').innerText = "Connected to TV";
                document.getElementById('body').classList.add('connected');
            });

            conn.on('data', (data) => {
                if (data.type === 'STATS') {
                    document.getElementById('cur-lap').innerText = data.lap;
                    document.getElementById('cur-time').innerText = data.time;
                    const slider = document.getElementById('seek-slider');
                    slider.max = data.duration;
                    // Only update slider if user isn't touching it
                    if (!window.isTouching) slider.value = data.currentTime;
                }
            });
        }

        const slider = document.getElementById('seek-slider');
        slider.addEventListener('touchstart', () => window.isTouching = true);
        slider.addEventListener('touchend', () => window.isTouching = false);
        slider.addEventListener('input', (e) => {
            if (conn && conn.open) {
                conn.send({ type: 'SEEK', value: e.target.value });
            }
        });
    </script>
</body>

</html>